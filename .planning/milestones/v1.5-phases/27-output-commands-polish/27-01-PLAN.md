---
phase: 27
plan: 1
title: "LaTeX output command and save-to-file command"
estimates:
  tasks: 5
  complexity: low
  time: "15 min"
requirements:
  - OUT-02
  - OUT-03
depends_on: []
---

# Plan 27-01: LaTeX Output Command and Save-to-File Command

## Context

Phase 26 shipped the REPL shell with commands.rs dispatching `help`, `set precision`, `clear`, and `quit`/`exit`. The help system already lists `latex` and `save` as "coming soon". This plan implements both commands and removes the placeholder text.

LaTeX rendering for FPS already exists in `crates/qsym-python/src/series.rs` (`latex()` + `latex_term()`). We port this logic into qsym-cli's format module. The Expr-level LaTeX renderer (`qsym_core::render::latex::to_latex`) operates on ExprRef/ExprArena which the CLI evaluator doesn't use (it works with `Value`/`FormalPowerSeries` directly), so we use the FPS-level approach from the Python crate.

## Tasks

### Task 1: Add `format_latex` to format.rs

Port the `latex()` and `latex_term()` helper from `qsym-python/src/series.rs` into `qsym-cli/src/format.rs` as a standalone `format_latex(val: &Value) -> String` function.

**Actions:**
1. In `format.rs`, add `use std::fmt::Write;` and `use std::cmp::Ordering;`
2. Add `pub fn format_latex(val: &Value) -> String` that pattern-matches on Value variants:
   - `Value::Series(fps)` → calls `fps_to_latex(fps)` (ported from Python's `latex()`)
   - `Value::Integer(n)` → `n.to_string()`
   - `Value::Rational(r)` → `\frac{numer}{denom}` (handle negative)
   - `Value::List(items)` → comma-joined in `\left[...\right]`
   - `Value::Dict(entries)` → `\{key: val, ...\}`
   - `Value::Pair(a,b)` → `\left(a, b\right)`
   - `Value::Bool(b)` → `\text{true}` / `\text{false}`
   - `Value::None` → `\text{NONE}`
   - `Value::Infinity` → `\infty`
3. Add `fn fps_to_latex(fps: &FormalPowerSeries) -> String` — port from Python's `latex()`:
   - Collect terms, truncation at 20 terms (15 + ... + last 2)
   - Append `+ O(q^{N})`
4. Add `fn latex_term(out: &mut String, first: bool, k: i64, c: &QRat)` — port from Python's `latex_term()`:
   - Sign handling (first vs subsequent)
   - Constant term (k=0), unit coefficient (|c|=1), general coefficient
   - Fraction formatting for non-integer rationals

**Tests (in format.rs):**
- `format_latex_integer`: `42` → `"42"`
- `format_latex_negative_rational`: `-3/7` → `"-\\frac{3}{7}"`
- `format_latex_series`: monomial q → contains `q` and `O(q^{`
- `format_latex_infinity`: → `"\\infty"`
- `format_latex_bool`: true → `"\\text{true}"`
- `format_latex_none`: → `"\\text{NONE}"`
- `format_latex_list`: `[1, 2]` → `"\\left[1, 2\\right]"`

**Commit:** `feat(cli): add LaTeX formatting for all Value types`

### Task 2: Add Latex and Save command variants

Extend `commands.rs` to parse and execute `latex` and `save` commands.

**Actions:**
1. Add to `Command` enum:
   - `Latex(Option<String>)` — `None` = last result, `Some(name)` = named variable
   - `Save(String)` — filename to write to
2. In `parse_command()`, add match arms:
   - `"latex"` → if 1 word: `Latex(None)`, if 2 words: `Latex(Some(words[1]))`, else None. Guard against `(` for function-call passthrough.
   - `"save"` → if 2 words: `Save(words[1])`, if 1 word: error variant (no filename), else None. Guard against `(` and `:=`.
3. In `execute_command()`, add match arms:
   - `Command::Latex(None)` → check `env.last_result`, if Some → `format_latex(&val)`, if None → "No result to display"
   - `Command::Latex(Some(name))` → check `env.get_var(&name)`, if Some → `format_latex(&val)`, if None → "Unknown variable 'name'"
   - `Command::Save(filename)` → delegate to a new `save_to_file` function (Task 3)

**Tests (in commands.rs):**
- `parse_latex_bare`: `"latex"` → `Some(Command::Latex(None))`
- `parse_latex_var`: `"latex f"` → `Some(Command::Latex(Some("f".into())))`
- `parse_latex_case_insensitive`: `"LATEX"` → `Some(Command::Latex(None))`
- `parse_latex_function_passthrough`: `"latex(x)"` → `None`
- `parse_save_filename`: `"save results.txt"` → `Some(Command::Save("results.txt".into()))`
- `parse_save_no_filename`: `"save"` → `Some(Command::Save("".into()))` (will error on execute)
- `parse_save_assignment_passthrough`: `"save := 5"` → `None`
- `execute_latex_no_result`: → error message
- `execute_latex_with_last_result`: set last_result to Integer(42) → "42"
- `execute_latex_var`: set var "f" to Integer(7) → "7"
- `execute_latex_unknown_var`: → error message

**Commit:** `feat(cli): add latex and save command parsing and dispatch`

### Task 3: Implement save_to_file

Add the file-writing logic for the `save` command.

**Actions:**
1. In `commands.rs`, add `use std::fs;` and `use crate::format::{format_value, format_latex};`
2. Add function `fn save_to_file(filename: &str, env: &Environment) -> CommandResult`:
   - If filename is empty → error message "Usage: save filename"
   - If `env.last_result` is None → error message "No result to save"
   - Otherwise, write `format_value(&val)` to file using `fs::write(filename, content)`
   - On success → "Result saved to {filename}"
   - On `Err(e)` → "Error writing to {filename}: {e}"
3. Wire `Command::Save(filename)` in `execute_command` to call `save_to_file(&filename, env)`

**Tests (in commands.rs):**
- `execute_save_no_filename`: Save("") → error message about usage
- `execute_save_no_result`: Save("test.txt") with no last_result → error message
- `execute_save_writes_file`: set last_result, save to temp file, verify file contents (use tempfile or std::env::temp_dir)
- `execute_save_bad_path`: save to invalid path → error message

**Commit:** `feat(cli): implement save-to-file command`

### Task 4: Update help system and tab completion

Remove "coming soon" annotations and add `latex`/`save` to tab completion.

**Actions:**
1. In `help.rs`, update `general_help()`:
   - Change `latex [expr]      - show LaTeX for last result or expression (coming soon)` to `latex [var]       - show LaTeX for last result or a variable`
   - Change `save filename     - save result to file (coming soon)` to `save filename     - save last result to a file`
2. In `repl.rs`, add `"latex"` and `"save"` to `command_names` in `ReplHelper::new()`:
   - Change `vec!["help", "quit", "exit", "clear", "set"]` to `vec!["help", "quit", "exit", "clear", "set", "latex", "save"]`

**Tests:**
- `help_shows_latex_without_coming_soon`: general_help() output contains "latex" but not "coming soon"
- `complete_latex_command`: typing "lat" at line start completes to "latex"
- `complete_save_command`: typing "sav" at line start completes to "save"

**Commit:** `feat(cli): update help and tab completion for latex/save commands`

### Task 5: Build verification and state updates

**Actions:**
1. Run `cargo test -p qsym-cli` — all tests must pass
2. Run `cargo build -p qsym-cli` — must compile cleanly

## Verification Criteria

| # | Truth | How to verify |
|---|-------|---------------|
| 1 | `latex` with no args shows LaTeX for last computed result | execute_latex_with_last_result test |
| 2 | `latex f` shows LaTeX for variable `f` | execute_latex_var test |
| 3 | `latex` with no prior result gives descriptive error | execute_latex_no_result test |
| 4 | `latex` for a series produces valid LaTeX with `q^{...}` notation | format_latex_series test |
| 5 | `save results.txt` writes last result to file | execute_save_writes_file test |
| 6 | `save` with no filename gives usage error | execute_save_no_filename test |
| 7 | `save` with no prior result gives error | execute_save_no_result test |
| 8 | Help system shows latex/save without "coming soon" | help_shows_latex_without_coming_soon test |
| 9 | Tab completion includes `latex` and `save` | complete_latex_command, complete_save_command tests |
| 10 | All existing tests still pass | cargo test -p qsym-cli |

## File Change Summary

| File | Action | Lines |
|------|--------|-------|
| `crates/qsym-cli/src/format.rs` | Add format_latex, fps_to_latex, latex_term | +120 |
| `crates/qsym-cli/src/commands.rs` | Add Latex/Save variants, parsing, execution, save_to_file | +80 |
| `crates/qsym-cli/src/help.rs` | Remove "coming soon" text | ~2 lines changed |
| `crates/qsym-cli/src/repl.rs` | Add "latex", "save" to command_names | ~1 line changed |
