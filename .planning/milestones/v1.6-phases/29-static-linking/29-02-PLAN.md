---
phase: 29-static-linking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/cli-release.yml
autonomous: true
requirements:
  - BUILD-02
  - BUILD-03

must_haves:
  truths:
    - "CI builds GMP/MPFR/MPC from bundled source without pre-installed system libraries"
    - "The Windows release archive contains exactly one file: q-kangaroo.exe (no DLLs)"
    - "The Linux release archive contains exactly one file: q-kangaroo"
    - "CI verifies the built binaries have no non-system shared library dependencies"
  artifacts:
    - path: ".github/workflows/cli-release.yml"
      provides: "CI release workflow with static builds and single-file archives"
      contains: "diffutils m4 make mingw-w64-x86_64-gcc"
  key_links:
    - from: ".github/workflows/cli-release.yml (build-windows)"
      to: "gmp-mpfr-sys build.rs"
      via: "MSYS2 shell provides sh/m4/make/gcc for configure+make"
      pattern: "shell: msys2"
    - from: ".github/workflows/cli-release.yml (build-linux)"
      to: "gmp-mpfr-sys build.rs"
      via: "Ubuntu pre-installed gcc/m4/make/diffutils"
      pattern: "cargo build --release"
    - from: ".github/workflows/cli-release.yml (build-windows)"
      to: "dist/q-kangaroo-windows-x86_64.zip"
      via: "Single exe packaging (no DLL copy steps)"
      pattern: "7z a q-kangaroo-windows-x86_64.zip q-kangaroo.exe"
---

<objective>
Rewrite the CI release workflow to build from bundled GMP source (no pre-installed libraries) and produce single-file release archives (no DLLs).

Purpose: The current CI workflow installs pre-built GMP packages and bundles 5 DLLs alongside the Windows exe. After static linking, CI needs only build tools (gcc, m4, make, diffutils) and the release archive should contain just the executable.
Output: Updated `.github/workflows/cli-release.yml` with static builds, dependency verification, and single-file archives.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-static-linking/29-RESEARCH.md
@.github/workflows/cli-release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Linux build job for static GMP</name>
  <files>.github/workflows/cli-release.yml</files>
  <action>
Rewrite the `build-linux` job in `.github/workflows/cli-release.yml`. The key changes:

1. **Remove the "Install GMP" step entirely.** No `apt-get install libgmp-dev libmpfr-dev libmpc-dev`. Ubuntu 24.04 runners have gcc, m4, make, and diffutils pre-installed, which is all gmp-mpfr-sys needs to build from source.

2. **Add gmp-mpfr-sys cache directory** to the actions/cache paths. Add `~/.cache/gmp-mpfr-sys` to cache the compiled GMP/MPFR/MPC static libraries between builds:
```yaml
- uses: actions/cache@v4
  with:
    path: |
      ~/.cargo/registry
      ~/.cargo/git
      ~/.cache/gmp-mpfr-sys
      target
    key: linux-release-${{ hashFiles('**/Cargo.lock') }}
```

3. **Add a DLL dependency verification step** after the build:
```yaml
- name: Verify no GMP shared library dependency
  run: |
    echo "Shared library dependencies:"
    ldd target/release/q-kangaroo
    echo "---"
    if ldd target/release/q-kangaroo | grep -q "libgmp\|libmpfr\|libmpc"; then
      echo "ERROR: Binary has GMP/MPFR/MPC shared library dependencies!"
      exit 1
    fi
    echo "OK: No GMP/MPFR/MPC shared library dependencies"
```

4. **Keep** the existing "Verify binary runs" and "Package Linux binary" steps unchanged. The Linux archive was already a single file (just q-kangaroo in a tar.gz).

The complete `build-linux` job should be:
```yaml
build-linux:
  name: Build Linux Binary
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          ~/.cache/gmp-mpfr-sys
          target
        key: linux-release-${{ hashFiles('**/Cargo.lock') }}
    # gcc, m4, make, diffutils are pre-installed on Ubuntu 24.04
    - name: Build release binary
      run: cargo build --release -p qsym-cli
    - name: Verify binary runs
      run: |
        chmod +x target/release/q-kangaroo
        target/release/q-kangaroo --version
        ls -la target/release/q-kangaroo
    - name: Verify no GMP shared library dependency
      run: |
        echo "Shared library dependencies:"
        ldd target/release/q-kangaroo
        echo "---"
        if ldd target/release/q-kangaroo | grep -q "libgmp\|libmpfr\|libmpc"; then
          echo "ERROR: Binary has GMP/MPFR/MPC shared library dependencies!"
          exit 1
        fi
        echo "OK: No GMP/MPFR/MPC shared library dependencies"
    - name: Package Linux binary
      run: |
        mkdir -p dist
        cp target/release/q-kangaroo dist/
        cd dist && tar czf q-kangaroo-linux-x86_64.tar.gz q-kangaroo
    - uses: actions/upload-artifact@v4
      with:
        name: binary-linux
        path: dist/q-kangaroo-linux-x86_64.tar.gz
```
  </action>
  <verify>
Read back the file and confirm:
1. No `apt-get install` step for libgmp/libmpfr/libmpc
2. `~/.cache/gmp-mpfr-sys` is in the cache paths
3. A "Verify no GMP shared library dependency" step exists with `ldd` + `grep` check
  </verify>
  <done>
Linux build job installs no GMP system libraries, caches gmp-mpfr-sys build artifacts, and verifies the binary has no GMP/MPFR/MPC shared library dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Windows build job and packaging for static single-exe</name>
  <files>.github/workflows/cli-release.yml</files>
  <action>
Rewrite the `build-windows` job. This is the most significant change. Key modifications:

1. **Change MSYS2 packages** from pre-built GMP libraries to build tools only:
```yaml
# OLD: mingw-w64-x86_64-gcc mingw-w64-x86_64-gmp mingw-w64-x86_64-mpfr mingw-w64-x86_64-mpc
# NEW: only build tools needed by gmp-mpfr-sys build.rs
install: diffutils m4 make mingw-w64-x86_64-gcc
```
Note: `diffutils` provides `diff`, `m4` provides the macro processor, `make` provides GNU make, and `mingw-w64-x86_64-gcc` provides the MinGW GCC compiler. The `sh` command is provided by MSYS2 base.

2. **Remove the "Add MinGW to PATH" step.** No longer needed since we're running cargo from the MSYS2 shell.

3. **Change the build step to use MSYS2 shell** (`shell: msys2 {0}`) instead of `shell: bash`. This is CRITICAL because gmp-mpfr-sys's build.rs calls `sh -c configure` and `make`, which need MSYS2's full PATH including `/usr/bin` for m4, make, diff. Remove the `LIBRARY_PATH` and `C_INCLUDE_PATH` env vars (they pointed to pre-built GMP):
```yaml
- name: Build release binary
  shell: msys2 {0}
  run: |
    export PATH="$PATH:/c/Users/runneradmin/.cargo/bin"
    cargo build --release -p qsym-cli --target x86_64-pc-windows-gnu
```

4. **Add a cache step** with Windows-specific gmp-mpfr-sys cache path:
```yaml
- uses: actions/cache@v4
  with:
    path: |
      ~/.cargo/registry
      ~/.cargo/git
      C:/Users/runneradmin/AppData/Local/gmp-mpfr-sys
      target
    key: windows-release-${{ hashFiles('**/Cargo.lock') }}
```

5. **Add DLL dependency verification** step:
```yaml
- name: Verify no non-system DLL dependencies
  shell: msys2 {0}
  run: |
    echo "DLL dependencies:"
    objdump -p target/x86_64-pc-windows-gnu/release/q-kangaroo.exe | grep "DLL Name"
    echo "---"
    if objdump -p target/x86_64-pc-windows-gnu/release/q-kangaroo.exe | grep "DLL Name" | grep -qi "libgmp\|libmpfr\|libmpc\|libgcc\|libwinpthread"; then
      echo "ERROR: Binary has non-system DLL dependencies!"
      exit 1
    fi
    echo "OK: No non-system DLL dependencies"
```

6. **Replace DLL bundling with single-exe packaging.** Delete the old "Package Windows binary with DLLs" step (which copies 5 DLLs into a directory). Replace with:
```yaml
- name: Package Windows binary
  shell: bash
  run: |
    mkdir -p dist
    cp target/x86_64-pc-windows-gnu/release/q-kangaroo.exe dist/
    cd dist && 7z a q-kangaroo-windows-x86_64.zip q-kangaroo.exe
```
The zip now contains a single `q-kangaroo.exe` at the root (not inside a subdirectory), and no DLLs.

The complete `build-windows` job should be:
```yaml
build-windows:
  name: Build Windows Binary
  runs-on: windows-latest
  steps:
    - name: Configure line endings
      shell: bash
      run: git config --global core.autocrlf input
    - uses: actions/checkout@v4
    - name: Setup MSYS2 with build tools
      id: msys2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: false
        install: diffutils m4 make mingw-w64-x86_64-gcc
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-gnu
    - uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          C:/Users/runneradmin/AppData/Local/gmp-mpfr-sys
          target
        key: windows-release-${{ hashFiles('**/Cargo.lock') }}
    - name: Build release binary
      shell: msys2 {0}
      run: |
        export PATH="$PATH:/c/Users/runneradmin/.cargo/bin"
        cargo build --release -p qsym-cli --target x86_64-pc-windows-gnu
    - name: Verify no non-system DLL dependencies
      shell: msys2 {0}
      run: |
        echo "DLL dependencies:"
        objdump -p target/x86_64-pc-windows-gnu/release/q-kangaroo.exe | grep "DLL Name"
        echo "---"
        if objdump -p target/x86_64-pc-windows-gnu/release/q-kangaroo.exe | grep "DLL Name" | grep -qi "libgmp\|libmpfr\|libmpc\|libgcc\|libwinpthread"; then
          echo "ERROR: Binary has non-system DLL dependencies!"
          exit 1
        fi
        echo "OK: No non-system DLL dependencies"
    - name: Package Windows binary
      shell: bash
      run: |
        mkdir -p dist
        cp target/x86_64-pc-windows-gnu/release/q-kangaroo.exe dist/
        cd dist && 7z a q-kangaroo-windows-x86_64.zip q-kangaroo.exe
    - uses: actions/upload-artifact@v4
      with:
        name: binary-windows
        path: dist/q-kangaroo-windows-x86_64.zip
```

The `create-release` job stays UNCHANGED -- it already references the correct artifact names and zip filenames.
  </action>
  <verify>
Read back the file and confirm:
1. MSYS2 `install:` line has `diffutils m4 make mingw-w64-x86_64-gcc` (no gmp/mpfr/mpc packages)
2. Build step uses `shell: msys2 {0}` with cargo PATH export
3. No `LIBRARY_PATH` or `C_INCLUDE_PATH` env vars on the build step
4. No DLL copy steps (no `cp /mingw64/bin/lib*.dll`)
5. Package step creates zip with single `q-kangaroo.exe` (no subdirectory)
6. A "Verify no non-system DLL dependencies" step exists with `objdump` + `grep` check
7. `create-release` job is unchanged
  </verify>
  <done>
Windows build job uses only build tools (no pre-built GMP), runs cargo from MSYS2 shell, verifies no non-system DLL dependencies, and packages a single exe (no DLLs). Linux and Windows release archives each contain exactly one file. CI builds from bundled GMP source without pre-installed system libraries.
  </done>
</task>

</tasks>

<verification>
1. The workflow file has NO references to `libgmp-dev`, `libmpfr-dev`, `libmpc-dev`, `mingw-w64-x86_64-gmp`, `mingw-w64-x86_64-mpfr`, or `mingw-w64-x86_64-mpc`
2. The workflow file has NO DLL copy steps (no `cp` of `.dll` files)
3. Both build jobs have DLL/shared-library verification steps that will fail the CI if non-system dependencies are found
4. The Windows package step creates a flat zip with just `q-kangaroo.exe`
5. The Linux package step creates a tar.gz with just `q-kangaroo`
6. The `create-release` job is unchanged
</verification>

<success_criteria>
CI workflow builds both Linux and Windows binaries from bundled GMP source (BUILD-02). Release archives contain only the executable -- no DLLs (BUILD-03). Both builds include automated verification that no GMP/MPFR/MPC shared library dependencies exist.
</success_criteria>

<output>
After completion, create `.planning/phases/29-static-linking/29-02-SUMMARY.md`
</output>
