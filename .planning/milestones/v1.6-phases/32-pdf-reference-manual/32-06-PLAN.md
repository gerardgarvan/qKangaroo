---
phase: 32-pdf-reference-manual
plan: 06
type: execute
wave: 2
depends_on: [32-01]
files_modified:
  - .github/workflows/cli-release.yml
  - crates/qsym-cli/src/main.rs
autonomous: true
requirements: [DOC-04, DOC-05, DOC-06]

must_haves:
  truths:
    - "CI release workflow compiles Typst source to PDF and includes it in GitHub release"
    - "q-kangaroo --help output mentions the PDF reference manual"
    - "PDF is named q-kangaroo-manual.pdf in release artifacts"
  artifacts:
    - path: ".github/workflows/cli-release.yml"
      provides: "build-manual job that compiles Typst and attaches PDF to release"
      contains: "typst compile"
    - path: "crates/qsym-cli/src/main.rs"
      provides: "Updated print_usage() mentioning PDF manual"
      contains: "Reference Manual"
  key_links:
    - from: ".github/workflows/cli-release.yml"
      to: "manual/main.typ"
      via: "typst compile command"
      pattern: "typst compile manual/main.typ"
---

<objective>
Add Typst PDF compilation to the CI release workflow and update --help to mention the manual.

Purpose: Ensure the PDF manual is automatically compiled and included in every GitHub release (DOC-04, DOC-05), and that users know about it from --help output (DOC-06).

Output: Updated .github/workflows/cli-release.yml and crates/qsym-cli/src/main.rs
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/32-pdf-reference-manual/32-RESEARCH.md
@.github/workflows/cli-release.yml
@crates/qsym-cli/src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF build job to CI release workflow</name>
  <files>.github/workflows/cli-release.yml</files>
  <action>
Read the existing `.github/workflows/cli-release.yml` and add a new job `build-manual` that:

1. **Job definition** (add BEFORE `create-release` job):
```yaml
  build-manual:
    name: Build PDF Manual
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: typst-community/setup-typst@v4
      - name: Compile PDF
        run: typst compile manual/main.typ q-kangaroo-manual.pdf
      - uses: actions/upload-artifact@v4
        with:
          name: manual-pdf
          path: q-kangaroo-manual.pdf
```

2. **Update `create-release` job**:
- Add `build-manual` to the `needs` array: `needs: [build-linux, build-windows, build-manual]`
- Update the `download-artifact` step's pattern to include manual: `pattern: '{binary-*,manual-pdf}'` (or use `merge-multiple: true` without pattern filtering -- just download all)
- Add `q-kangaroo-manual.pdf` to the `files` list in the `softprops/action-gh-release` step:
```yaml
          files: |
            dist/q-kangaroo-linux-x86_64.tar.gz
            dist/q-kangaroo-windows-x86_64.zip
            dist/q-kangaroo-manual.pdf
```

Key details:
- The manual PDF is uploaded as a STANDALONE artifact (not inside the binary archives) so users can download it separately
- typst-community/setup-typst@v4 handles Typst installation and caching
- Compile command: `typst compile manual/main.typ q-kangaroo-manual.pdf` (output to repo root, not manual/ subdirectory, for easier artifact handling)
- The build-manual job is fast (~10 seconds) and runs in parallel with binary builds
  </action>
  <verify>
Verify the updated workflow file:
- Contains `build-manual` job with `typst-community/setup-typst@v4` step
- Contains `typst compile manual/main.typ` command
- `create-release` job's `needs` includes `build-manual`
- Release files list includes `q-kangaroo-manual.pdf`
  </verify>
  <done>
CI release workflow builds PDF from Typst source (DOC-04) and includes it in GitHub release artifacts alongside binary archives (DOC-05).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update --help to mention PDF manual</name>
  <files>crates/qsym-cli/src/main.rs</files>
  <action>
Read `crates/qsym-cli/src/main.rs` and locate the `print_usage()` function (around line 120).

Add a DOCUMENTATION section at the end of the help text, after the EXAMPLES section and before the final closing of the function. Add these lines:

```rust
    println!();
    println!("DOCUMENTATION:");
    println!("  See the q-Kangaroo Reference Manual (PDF) included with release downloads.");
    println!("  In interactive mode, type 'help' for available functions.");
```

This replaces the existing final line `println!("In interactive mode, type 'help' for available functions.");` -- move it into the DOCUMENTATION section rather than having it standalone.

After the change, the print_usage() function should output:
```
q-kangaroo VERSION -- symbolic q-series computation

USAGE:
  q-kangaroo [OPTIONS] [FILE]
  q-kangaroo -c EXPRESSION
  command | q-kangaroo

OPTIONS:
  -h, --help       Show this help message and exit
  -V, --version    Show version and exit
  -c EXPRESSION    Evaluate expression and exit
  -q, --quiet      Suppress banner in interactive mode
  -v, --verbose    Show per-statement timing
  --               End of options (treat next arg as filename)

EXAMPLES:
  q-kangaroo script.qk         Execute a script file
  q-kangaroo -c "etaq(1,1,20)"  Evaluate an expression
  echo "1+1" | q-kangaroo       Pipe input

DOCUMENTATION:
  See the q-Kangaroo Reference Manual (PDF) included with release downloads.
  In interactive mode, type 'help' for available functions.
```

Then run the existing CLI tests to ensure nothing breaks:
```bash
export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH"
cargo test -p qsym-cli --test integration_tests -- help 2>&1 | head -30
```

If there is an existing test that checks --help output exactly, update it to include the new DOCUMENTATION section.
  </action>
  <verify>
Run:
```bash
export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH"
cargo test -p qsym-cli 2>&1 | tail -5
```
All tests pass. The print_usage() function includes "Reference Manual (PDF)" text.
  </verify>
  <done>
`q-kangaroo --help` output includes DOCUMENTATION section mentioning the PDF reference manual (DOC-06). All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- CI workflow has build-manual job with Typst compile step
- create-release job depends on build-manual
- Release files include q-kangaroo-manual.pdf
- print_usage() contains "Reference Manual" text
- All existing CLI tests pass after the change
</verification>

<success_criteria>
- DOC-04: PDF compiled from Typst source at release time (build-manual job)
- DOC-05: PDF included in GitHub release archives alongside binary (release files list)
- DOC-06: --help output mentions the PDF manual (DOCUMENTATION section)
</success_criteria>

<output>
After completion, create `.planning/phases/32-pdf-reference-manual/32-06-SUMMARY.md`
</output>
