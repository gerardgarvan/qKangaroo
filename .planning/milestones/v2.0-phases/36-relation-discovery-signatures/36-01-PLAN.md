---
phase: 36-relation-discovery-signatures
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-core/src/qseries/relations.rs
  - crates/qsym-core/src/qseries/mod.rs
autonomous: true
requirements:
  - SIG-25
  - OUT-02

must_haves:
  truths:
    - "generate_monomials is callable from CLI crate for polynomial formatting"
    - "generate_nonhom_monomials is callable from CLI crate for nonhomogeneous formatting"
    - "findcong_garvan auto-scans all moduli 2..LM and reports [B, A, R] triples via GCD factoring"
    - "Trial division factoring correctly identifies prime power divisors of GCDs"
  artifacts:
    - path: "crates/qsym-core/src/qseries/relations.rs"
      provides: "pub generate_monomials, pub generate_nonhom_monomials, findcong_garvan, trial_factor"
      contains: "pub fn generate_monomials"
    - path: "crates/qsym-core/src/qseries/mod.rs"
      provides: "re-exports for new pub functions"
      contains: "generate_monomials"
  key_links:
    - from: "crates/qsym-core/src/qseries/relations.rs"
      to: "crates/qsym-core/src/qseries/mod.rs"
      via: "pub use re-export"
      pattern: "pub use relations::"
---

<objective>
Make monomial generators public and implement Garvan's findcong auto-scan algorithm in the core library.

Purpose: The CLI dispatch layer (Plan 36-02) needs pub access to generate_monomials to format polynomial output with X[i] labels. The findcong function needs a fundamental algorithm change from explicit moduli list to Garvan's automatic modulus-scanning with GCD factoring.

Output: Updated relations.rs with pub monomial generators and new findcong_garvan function; updated mod.rs re-exports.
</objective>

<execution_context>
@C:/Users/Owner/.claude/agents/gsd-executor.md
@C:/Users/Owner/.claude/agents/gsd-summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-relation-discovery-signatures/36-RESEARCH.md
@crates/qsym-core/src/qseries/relations.rs
@crates/qsym-core/src/qseries/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make monomial generators pub and add findcong_garvan</name>
  <files>crates/qsym-core/src/qseries/relations.rs, crates/qsym-core/src/qseries/mod.rs</files>
  <action>
In relations.rs:

1. Make `generate_monomials` public: change `fn generate_monomials` to `pub fn generate_monomials` (line ~158). This generates all k-tuples of non-negative integers summing to exactly `degree`. Keep `generate_monomials_recursive` private.

2. Add a new public function `generate_nonhom_monomials(k: usize, max_degree: i64) -> Vec<Vec<i64>>` that generates all monomials of degree 0, 1, ..., max_degree (matching the logic already in `findnonhom` lines ~507-511). This is used by findnonhom and findnonhomcombo output formatting.

3. Add a `trial_factor(n: i64) -> Vec<(i64, u32)>` helper function that factors a positive integer into prime-power pairs using trial division up to sqrt(n). Example: `trial_factor(12)` returns `[(2, 2), (3, 1)]`. This is used by findcong_garvan. Keep it simple -- GCDs from partition-type series are typically small.

4. Add the new `findcong_garvan` function matching Garvan's algorithm:
```rust
pub fn findcong_garvan(
    f: &FormalPowerSeries,
    t: i64,                       // truncation upper bound
    lm: Option<i64>,              // max modulus (default: floor(sqrt(T)))
    xset: &std::collections::HashSet<i64>,  // excluded prime powers
) -> Vec<Congruence>
```
Algorithm:
- Compute `lm_val = lm.unwrap_or_else(|| (t as f64).sqrt().floor() as i64)`
- For each modulus `m` in 2..=lm_val:
  - For each residue `r` in 0..m:
    - Compute max_n = (t - r) / m (integer division, skip if negative)
    - Collect coefficients: for n=0..=max_n, extract f.coeff(m*n + r) as integer (numerator, check denom==1)
    - Skip if all coefficients are zero
    - Compute GCD of all nonzero coefficients using rug::Integer::gcd
    - If GCD <= 1, continue
    - Factor the GCD using trial_factor
    - For each prime power p^e in the factorization, if p^e is not in xset, push Congruence { modulus_m: m, residue_b: r, divisor_r: p^e }

5. Keep the existing `findcong` function unchanged (it's still used by existing tests until Plan 36-02 switches the dispatch). The new function is `findcong_garvan` -- a separate entry point.

6. In mod.rs, update the `pub use relations::` line to add: `generate_monomials`, `generate_nonhom_monomials`, `findcong_garvan`. Keep all existing re-exports.

IMPORTANT: Use `rug::Integer::gcd` for GCD computation -- the rug library is already a dependency. For computing GCD of a list, fold with gcd: `coeffs.iter().fold(Integer::from(0), |acc, c| Integer::from(acc.gcd_ref(c)))` or similar. The GCD of an empty list is 0; GCD(0, x) = x.

For trial_factor, handle n <= 1 by returning empty vec. For n >= 2, trial divide by 2, then odd numbers 3, 5, 7, ... up to sqrt(n). Return Vec<(i64, u32)> of (prime, exponent) pairs.
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /c/cygwin64/home/Owner/Kangaroo && cargo test -p qsym-core --lib -- relations 2>&1 | tail -20`
All existing relations tests must pass. The new functions compile correctly.
  </verify>
  <done>
generate_monomials and generate_nonhom_monomials are pub and re-exported. findcong_garvan compiles and is re-exported. trial_factor is available. All existing tests pass with zero regressions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for findcong_garvan and trial_factor</name>
  <files>crates/qsym-core/src/qseries/relations.rs</files>
  <action>
Add unit tests in the existing `#[cfg(test)]` module in relations.rs (or create one if it doesn't exist at the bottom of the file):

1. `test_trial_factor_basic`: Verify trial_factor(1) == [], trial_factor(2) == [(2,1)], trial_factor(12) == [(2,2),(3,1)], trial_factor(25) == [(5,2)], trial_factor(7) == [(7,1)], trial_factor(100) == [(2,2),(5,2)].

2. `test_generate_monomials_pub`: Verify generate_monomials(2, 2) returns the expected 3 monomials: [2,0], [1,1], [0,2]. Verify generate_monomials(3, 1) returns 3 monomials.

3. `test_generate_nonhom_monomials`: Verify generate_nonhom_monomials(2, 1) returns monomials for degree 0 and degree 1: [0,0], [1,0], [0,1] (3 total). Verify generate_nonhom_monomials(2, 2) returns 6 monomials (1 + 2 + 3).

4. `test_findcong_garvan_partition_congruences`: Build partition_gf(100) using `crate::qseries::partition_gf`. Call `findcong_garvan(&pgf, 100, None, &HashSet::new())`. Verify that the results contain the Ramanujan congruence: a triple with residue_b=4, modulus_m=5, divisor_r=5 (p(5n+4) = 0 mod 5). Also check for p(7n+5) = 0 mod 7 triple.

5. `test_findcong_garvan_with_lm`: Call findcong_garvan with explicit lm=5 and verify it only scans moduli 2..5 (no modulus 7 results).

6. `test_findcong_garvan_with_xset`: Call findcong_garvan with xset={5} and verify the p(5n+4) mod 5 result is excluded but p(7n+5) mod 7 is still present.

Use `use std::collections::HashSet;` for xset tests.
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /c/cygwin64/home/Owner/Kangaroo && cargo test -p qsym-core --lib -- relations 2>&1 | tail -30`
All new tests pass. All existing tests still pass.
  </verify>
  <done>
6 new unit tests pass covering trial_factor, generate_monomials, generate_nonhom_monomials, and findcong_garvan with all three call forms (default LM, explicit LM, XSET filtering). Total core test count increases by 6.
  </done>
</task>

</tasks>

<verification>
- `cargo test -p qsym-core` passes with zero failures
- `generate_monomials` and `generate_nonhom_monomials` are accessible as `qseries::generate_monomials` etc.
- `findcong_garvan` finds Ramanujan's p(5n+4) = 0 mod 5 from partition_gf(100)
</verification>

<success_criteria>
- generate_monomials is pub and re-exported from qseries
- generate_nonhom_monomials exists, is pub, and re-exported
- findcong_garvan implements Garvan's auto-scan algorithm with GCD + trial factoring
- trial_factor correctly factors small integers
- 6 new unit tests pass
- Zero regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/36-relation-discovery-signatures/36-01-SUMMARY.md`
</output>
