---
phase: 39-output-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-cli/src/format.rs
  - crates/qsym-cli/src/help.rs
  - crates/qsym-cli/tests/cli_integration.rs
autonomous: true
requirements: [OUT-03, COMPAT-02]

must_haves:
  truths:
    - "Series output displays terms in descending power order (highest power first)"
    - "LaTeX output displays terms in descending power order"
    - "O(q^T) truncation marker still appears at the end of series output"
    - "Exact polynomials display without O(...) in descending order"
    - "All existing tests pass with zero regressions after assertion updates"
    - "Help example_output strings reflect descending ordering"
  artifacts:
    - path: "crates/qsym-cli/src/format.rs"
      provides: "Descending iteration in format_series() and fps_to_latex()"
      contains: ".rev()"
    - path: "crates/qsym-cli/src/help.rs"
      provides: "Updated example_output strings in descending order"
    - path: "crates/qsym-cli/tests/cli_integration.rs"
      provides: "Updated test assertions matching descending display"
  key_links:
    - from: "format_series()"
      to: "BTreeMap::iter().rev()"
      via: "reversed iteration for descending power output"
      pattern: "fps\\.iter\\(\\)\\.rev\\(\\)"
    - from: "fps_to_latex()"
      to: "terms.iter().rev()"
      via: "reversed iteration for descending LaTeX output"
---

<objective>
Implement Maple-style descending polynomial display ordering for all series output and update every test assertion and help example to match the new format.

Purpose: Maple displays polynomials with highest power first (e.g., `q^4 + q^3 + 2*q^2 + q + 1`). This phase makes q-Kangaroo match that convention so researchers see familiar output.

Output: Modified `format.rs` with descending iteration, updated test assertions in `format.rs` unit tests and `cli_integration.rs`, updated help example strings in `help.rs`.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-output-compatibility/39-RESEARCH.md
@crates/qsym-cli/src/format.rs
@crates/qsym-cli/src/help.rs
@crates/qsym-cli/tests/cli_integration.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all test assertions and help examples to descending order</name>
  <files>
    crates/qsym-cli/src/format.rs
    crates/qsym-cli/src/help.rs
    crates/qsym-cli/tests/cli_integration.rs
  </files>
  <action>
Update every test assertion and help example_output string that checks polynomial/series ordering from ascending to descending order. This is done BEFORE changing format code so we can verify the full list of affected assertions.

**format.rs unit tests (exact assertions to change):**
1. `format_polynomial_no_truncation`: change `assert_eq!(result, "1 + 2*q + q^2")` to `assert_eq!(result, "q^2 + 2*q + 1")`
2. `format_latex_polynomial_no_truncation`: change `assert_eq!(result, "1 + q^{2}")` to `assert_eq!(result, "q^{2} + 1")`

**cli_integration.rs (assertions checking specific ordering):**
1. `maple_qbin_garvan_3arg` (line 1009): change `"1 + q + 2*q^2 + q^3 + q^4"` to `"q^4 + q^3 + 2*q^2 + q + 1"`
2. `theta_numeric_z` (line 1477): change `"1 + 2*q + 2*q^4"` to `"2*q^4 + 2*q + 1"`
3. `jac2series_single_factor` (line 1489): change `"1 - q"` to something that matches descending (q;q)_inf. In descending order the highest-power terms come first: this is `q^7 - q^5 - q^2 + q - 1` reversed -- actually for O(q^10) the displayed terms are coefficients at powers 0,1,2,5,7. In descending: `q^7 + q^5 - q^2 - q + 1`. Wait -- let me be precise. (q;q)_inf = 1 - q - q^2 + q^5 + q^7 + O(q^10). In descending: `q^7 + q^5 - q^2 - q + 1 + O(q^10)`. The test checks `stdout.contains("1 - q")` which won't match descending. Change to check `stdout.contains("q^7")` or `stdout.contains("- q + 1")` -- use `stdout.contains("q^7 + q^5")` as a descending check.

**help.rs example_output strings (all series examples):**
Update all `example_output` fields that show ascending polynomial terms to show descending order. The key ones with explicit multi-term output:
- Line 147: `"1 - q^2 - q^3 + q^5 + q^8 - q^12 - q^14"` -> reverse to `"-q^14 - q^12 + q^8 + q^5 - q^3 - q^2 + 1"` (but this is `aqprod` for a polynomial; verify sign of leading term)
- Line 154: `"1 + q + 2*q^2 + q^3 + q^4"` -> `"q^4 + q^3 + 2*q^2 + q + 1"`
- Line 161: `"1 - q - q^2 + q^5 + q^7 + O(q^10)"` -> `"q^7 + q^5 - q^2 - q + 1 + O(q^10)"`  (note: this is actually etaq output which for eta(q) = q^(1/24)*prod; need to verify actual output)
- Lines with `+ O(q^10)` at end: just reverse the terms before the O(...) part
- Lines with `...` ellipsis: just reverse the visible first terms

IMPORTANT: For help example_output strings that use `...` (ellipsis) to abbreviate, update the visible terms to show highest-power-first. For instance `"1 + q + 2*q^2 + 3*q^3 + ... + O(q^10)"` becomes something like `"... + 3*q^3 + 2*q^2 + q + 1 + O(q^10)"` -- BUT since actual output shows first 15 terms, the `...` pattern in help examples is just illustrative. Update the visible portion to descending order.

NOTE: Do NOT change assertions that only check for `O(q^T)` presence, exit codes, or `stdout.contains("q")` -- those are order-independent and remain valid.

NOTE: For help examples, many use `...` as illustrative approximations. For those, update the visible leading terms to descending but keep `... + O(q^T)` at the end. The `...` represents omitted middle terms.

CRITICAL: Run `cargo test -p qsym-cli --lib` after making changes. Tests WILL FAIL at this point (expected -- format code not yet changed). Capture the failure count for reference.
  </action>
  <verify>
Run `cargo test -p qsym-cli --lib -- format::tests` (expect failures on format_polynomial_no_truncation and format_latex_polynomial_no_truncation since display code hasn't changed yet). Confirm the assertions were updated correctly by reading the modified files.
  </verify>
  <done>
All test assertions and help example_output strings updated from ascending to descending polynomial ordering. The exact set of changes is documented. Tests fail as expected (format code not yet changed).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement descending iteration in format_series() and fps_to_latex()</name>
  <files>crates/qsym-cli/src/format.rs</files>
  <action>
Change the iteration order in both series display functions from ascending to descending by adding `.rev()`.

**format_series() (line 132):**
Change `for (&k, c) in fps.iter()` to `for (&k, c) in fps.iter().rev()`.

The existing first-term/sign logic is position-independent (it handles the first displayed term regardless of power), so no changes needed beyond `.rev()`. The O(q^T) truncation marker is appended after the loop and remains at the end -- no change needed there.

**fps_to_latex() (line 271 area):**
The LaTeX function collects terms into a Vec, then iterates. Change the iteration to use `.rev()`:
- Line 291: `for (i, (k, c)) in terms.iter().enumerate().take(show_first)` -> `for (i, (k, c)) in terms.iter().rev().enumerate().take(show_first)`
- For the ellipsis "last terms" section (lines 298-301): when showing the last 2 terms after `\cdots`, these should be the LOWEST-power terms (since we're displaying descending). Change `terms[start..]` iteration to also use the correct slice. Since `terms` is still in ascending order (collected from BTreeMap), the "last" in ascending are the highest powers -- but we want to show highest first then `\cdots` then lowest. So:
  - First group: `terms.iter().rev().take(show_first)` = highest 15 terms in descending order
  - Ellipsis group: `terms.iter().take(show_last)` = lowest 2 terms in ascending order (which is actually ascending, but for consistency show them in descending too -- but there are only 2 so it doesn't matter much). Actually for proper descending display: after the first 15 highest terms + cdots, show the last 2 lowest terms. Use `terms.iter().take(show_last).rev()` to show them descending (though with 2 terms this gives q^1 before q^0).

Actually, simpler approach: reverse the entire terms Vec once, then iterate normally:
```rust
let terms: Vec<(&i64, &QRat)> = fps.iter().rev().collect();
```
Then the existing iteration code works as-is (first N terms are highest power, last terms are lowest power). This is the cleanest change. The ellipsis section `terms[start..]` already picks the "last" items which would now be the lowest powers.

**Verify sign handling:** After the change, test with a series containing negative leading coefficient (e.g., -q^3 + 2*q - 1). The first term logic: `if is_negative { out.push('-'); }` handles the sign correctly regardless of which power is first.

After this change, run the FULL test suite to verify everything passes.
  </action>
  <verify>
Run `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cargo test -p qsym-cli 2>&1 | tail -5` to verify all CLI tests pass (unit + integration).
Run `cargo test -p qsym-core 2>&1 | tail -5` to verify core tests unaffected.
  </verify>
  <done>
format_series() and fps_to_latex() both iterate in descending order. All format.rs unit tests pass. All cli_integration.rs tests pass. All qsym-core tests pass. Zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p qsym-cli` -- all tests pass (unit + integration)
2. `cargo test -p qsym-core` -- all core tests pass
3. Manual spot check: `q-kangaroo -c "qbin(4, 2, q, 10)"` outputs `q^4 + q^3 + 2*q^2 + q + 1` (descending)
4. Manual spot check: `q-kangaroo -c "etaq(q, 1, 10)"` outputs terms in descending power order with O(q^10) at end
5. Polynomials display without O(...) truncation
6. Help example_output strings show descending ordering
</verification>

<success_criteria>
- All series/polynomial output uses descending power ordering
- Both plain text and LaTeX output use descending ordering
- O(q^T) appears at the end (right side) of truncated series
- Exact polynomials display without O(...) marker
- All existing tests pass with zero regressions
- Help examples reflect new display format
</success_criteria>

<output>
After completion, create `.planning/phases/39-output-compatibility/39-01-SUMMARY.md`
</output>
