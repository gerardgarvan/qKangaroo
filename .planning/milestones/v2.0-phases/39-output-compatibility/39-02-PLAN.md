---
phase: 39-output-compatibility
plan: 02
type: execute
wave: 2
depends_on: [39-01]
files_modified:
  - crates/qsym-cli/tests/cli_integration.rs
autonomous: true
requirements: [COMPAT-01, COMPAT-02]

must_haves:
  truths:
    - "Every v1.x function signature continues to work and returns correct results"
    - "Old etaq(b, t, order) form produces the same result as Garvan etaq(q, b, order)"
    - "Old aqprod(cn, cd, power, n, order) form produces correct results"
    - "Old jacprod(a, b, order) form produces correct results"
    - "Old tripleprod(a, b, c, order) form produces correct results"
    - "Old quinprod(c, d, order) form produces correct results"
    - "Old qbin(n, k, order) form produces correct results"
    - "Old winquist(a, b, c, order) form produces correct results"
    - "Backward compat tests verify output correctness, not just exit code 0"
    - "All 830+ tests pass with zero regressions"
  artifacts:
    - path: "crates/qsym-cli/tests/cli_integration.rs"
      provides: "Dedicated backward_compat integration test section"
      contains: "backward_compat"
  key_links:
    - from: "backward_compat tests"
      to: "eval.rs dual dispatch branches"
      via: "CLI subprocess execution of old-style function calls"
      pattern: "backward_compat_"
---

<objective>
Add a dedicated backward compatibility integration test group that systematically verifies every v1.x function signature still works correctly after the Maple compatibility changes in Phases 33-38.

Purpose: Ensure no regressions in existing user workflows. Researchers using old syntax must get correct results silently (no deprecation warnings). This fulfills COMPAT-01 (old signatures work as aliases) and provides regression coverage for COMPAT-02.

Output: New `backward_compat` test section in `cli_integration.rs` with tests for all 24+ changed functions.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-output-compatibility/39-RESEARCH.md
@.planning/phases/39-output-compatibility/39-01-SUMMARY.md
@crates/qsym-cli/tests/cli_integration.rs
@crates/qsym-cli/src/eval.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add backward_compat integration test section for product/theta functions</name>
  <files>crates/qsym-cli/tests/cli_integration.rs</files>
  <action>
Add a new test section at the end of `cli_integration.rs` with the header:

```rust
// ===========================================================================
// Backward Compatibility: v1.x signatures (COMPAT-01, COMPAT-02)
// ===========================================================================
```

Add integration tests for ALL product/theta functions that had signature changes in Phases 33-38. Each test must:
1. Call the function with the OLD v1.x signature
2. Assert exit code 0
3. Assert output correctness (not just success) -- check for expected terms or O(q^T)

Functions to test (product/theta group):
- `backward_compat_etaq_legacy_3arg`: `etaq(1, 1, 20)` -- assert exit 0, contains `O(q^20)`, contains `q`
- `backward_compat_etaq_legacy_4arg`: `etaq(1, 2, 1, 20)` -- assert exit 0, contains `O(q^20)`
- `backward_compat_aqprod_legacy_5arg`: `aqprod(1, 1, 1, infinity, 20)` -- assert exit 0, contains `O(q^20)`
- `backward_compat_aqprod_legacy_5arg_finite`: `aqprod(1, 1, 2, 5, 20)` -- assert exit 0, output is polynomial or series
- `backward_compat_jacprod_legacy_3arg`: `jacprod(1, 5, 20)` -- assert exit 0, contains `O(q^20)`
- `backward_compat_tripleprod_legacy_4arg`: `tripleprod(1, 1, 1, 20)` -- assert exit 0, contains `O(q^20)`
- `backward_compat_quinprod_legacy_4arg`: `quinprod(1, 1, 1, 20)` -- assert exit 0, contains `O(q^20)`
- `backward_compat_winquist_legacy_4arg`: `winquist(1, 1, 1, 20)` -- assert exit 0
- `backward_compat_qbin_legacy_3arg`: `qbin(4, 2, 20)` -- assert exit 0, contains `q` (exact polynomial)
- `backward_compat_numbpart_alias`: `partition_count(100)` -- assert exit 0, contains `190569292`
- `backward_compat_numbpart_primary`: `numbpart(5)` -- assert exit 0, stdout is `7`

NOTE: Some of these overlap with existing Phase 34 tests. That's intentional -- the backward_compat section serves as a dedicated regression suite.
  </action>
  <verify>
Run `cargo test -p qsym-cli --test cli_integration backward_compat` to verify all new tests pass.
  </verify>
  <done>
All product/theta backward compatibility tests pass. Old signatures produce correct results with no deprecation warnings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add backward_compat tests for analysis, discovery, and utility functions</name>
  <files>crates/qsym-cli/tests/cli_integration.rs</files>
  <action>
Continue the backward_compat section with tests for all remaining changed functions.

**Series analysis functions (Phase 35 changes):**
Note: Phase 35 broke backward compat for sift/prodmake/etamake/jacprodmake/mprodmake/qetamake/qfactor -- old signatures intentionally error. So backward_compat tests for these confirm the NEW Maple signatures work, since there are no legacy forms to preserve.

- `backward_compat_sift_maple_5arg`: `f := partition_gf(50); sift(f, q, 5, 0, 50)` -- assert exit 0, contains `q`
- `backward_compat_prodmake_maple_3arg`: `f := partition_gf(30); prodmake(f, q, 15)` -- assert exit 0, contains `exponents`
- `backward_compat_etamake_maple_3arg`: `f := partition_gf(30); etamake(f, q, 10)` -- assert exit 0, contains `factors`
- `backward_compat_qfactor_maple_2arg`: `f := aqprod(q, q, 5, 20); qfactor(f, q)` -- assert exit 0, contains `factors`

**Relation discovery functions (Phase 36 changes):**
These also changed to Garvan-only signatures. Test the new forms work:

- `backward_compat_findlincombo_garvan`: Script test: `f := partition_gf(30):\ng := distinct_parts_gf(30):\nfindlincombo(f, [f, g], [F1, F2], q, 0)` -- assert exit 0, contains `F1`
- `backward_compat_findcong_garvan`: Script test: `p := partition_gf(201):\nfindcong(p, 200)` -- assert exit 0, contains `[4, 5, 5]`

**New functions (Phases 37-38 -- no legacy to preserve, just verify they work):**
- `backward_compat_theta_new`: `theta(1, q, 5)` -- assert exit 0, contains `q`
- `backward_compat_jac2series_new`: `jac2series(JAC(1,1), q, 10)` -- assert exit 0, contains `q`
- `backward_compat_checkmult_new`: `f := partition_gf(50); checkmult(f, 30)` -- assert exit 0
- `backward_compat_lqdegree0_new`: `f := partition_gf(20); lqdegree0(f)` -- assert exit 0, contains `0`

**Cross-validation test (key regression check):**
- `backward_compat_etaq_legacy_matches_garvan`: Script test that computes both forms and subtracts:
  ```
  a := etaq(1, 1, 20):
  b := etaq(q, 1, 20):
  a - b
  ```
  Assert exit 0, stdout should be `O(q^20)` (zero difference, only truncation marker).

After adding all tests, run the FULL test suite:
- `cargo test -p qsym-cli` (all CLI tests)
- `cargo test -p qsym-core` (all core tests)
  </action>
  <verify>
Run `cargo test -p qsym-cli --test cli_integration backward_compat` to verify all backward compat tests pass.
Run `cargo test -p qsym-cli 2>&1 | tail -5` for full CLI test count.
Run `cargo test -p qsym-core 2>&1 | tail -5` for core test count.
  </verify>
  <done>
All backward compatibility tests pass. The dedicated backward_compat section covers all 24+ changed functions with output correctness checks. Full test suite passes with zero regressions. Total test count documented.
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p qsym-cli --test cli_integration backward_compat` -- all backward compat tests pass
2. `cargo test -p qsym-cli` -- full CLI test suite (unit + integration) passes
3. `cargo test -p qsym-core` -- full core test suite passes
4. No test uses only exit-code-0 check without output validation (no false positives)
5. Cross-validation test confirms legacy and Garvan signatures produce identical results
</verification>

<success_criteria>
- Dedicated backward_compat test section exists in cli_integration.rs
- All product/theta legacy signatures tested (etaq, aqprod, jacprod, tripleprod, quinprod, winquist, qbin)
- All analysis functions tested with current Maple signatures
- Cross-validation test proves legacy = Garvan output
- Total test count: 830+ tests, zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/39-output-compatibility/39-02-SUMMARY.md`
</output>
