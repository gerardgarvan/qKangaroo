# Milestone v3.0: Scripting & Bivariate Series

**Status:** SHIPPED 2026-02-21
**Phases:** 41-46
**Total Plans:** 14 (including 1 gap closure plan)

## Overview

Every example in Garvan's "q-Product Tutorial" (qmaple.pdf) runs correctly in q-Kangaroo -- adding scripting language features (for-loops, procedures, conditionals), expression operations (series truncation, expansion, polynomial factoring, substitution), and bivariate (z,q)-series support for tripleprod/quinprod/winquist with symbolic z.

## Phases

### Phase 41: Control Flow Parsing
**Goal**: Users can write for-loops and if/elif/else conditionals that parse correctly into AST nodes with boolean and comparison operators
**Depends on**: Phase 40 (v2.0 complete)
**Requirements**: SCRIPT-01, SCRIPT-06, SCRIPT-07
**Plans**: 2 plans

Plans:
- [x] 41-01-PLAN.md -- Tokens, AST types, lexer extensions, and parser comparison/boolean operator support
- [x] 41-02-PLAN.md -- For-loop and if/elif/else parsing with statement sequences and REPL multiline detection

### Phase 42: Procedures & Evaluation
**Goal**: Users can define and call named procedures with local variables, early return, and memoization, and all control flow (for, if) evaluates correctly
**Depends on**: Phase 41
**Requirements**: SCRIPT-02, SCRIPT-03, SCRIPT-04, SCRIPT-05
**Plans**: 2 plans

Plans:
- [x] 42-01-PLAN.md -- Control flow evaluation (compare, bool, for, if) and RETURN/EarlyReturn support
- [x] 42-02-PLAN.md -- Procedure parsing, definition, calling, local scoping, memoization, format, and REPL multiline

### Phase 43: Expression Operations
**Goal**: Users can truncate series, expand products, use runtime arithmetic in q-exponents, and compute floor/legendre
**Depends on**: Phase 42
**Requirements**: SERIES-01, SERIES-02, SERIES-03, UTIL-01, UTIL-02
**Plans**: 2 plans

Plans:
- [x] 43-01-PLAN.md -- eval_pow Rational exponent arms, floor(), legendre(), L alias, help entries
- [x] 43-02-PLAN.md -- series() truncation, expand() product expansion, help entries

### Phase 44: Polynomial Operations
**Goal**: Users can factor polynomials in q and substitute values into expressions
**Depends on**: Phase 43
**Requirements**: POLY-01, POLY-02
**Plans**: 2 plans

Plans:
- [x] 44-01-PLAN.md -- Core cyclotomic/factor modules, CLI factor() dispatch, help, completion
- [x] 44-02-PLAN.md -- subs() AST interception, substitution logic, help, completion

### Phase 45: Bivariate Series
**Goal**: Users can compute tripleprod, quinprod, and winquist with symbolic z variables, getting Laurent polynomials in z with q-series coefficients, and perform arithmetic on these bivariate values
**Depends on**: Phase 41 (control flow for testing), Phase 43 (expression operations)
**Requirements**: BIVAR-01, BIVAR-02, BIVAR-03, BIVAR-04
**Plans**: 4 plans

Plans:
- [x] 45-01-PLAN.md -- BivariateSeries core struct, arithmetic, Value variant, display formatting
- [x] 45-02-PLAN.md -- tripleprod/quinprod bivariate dispatch via sum-form identities, help updates
- [x] 45-03-PLAN.md -- winquist one-symbolic bivariate dispatch via direct Pochhammer factors, help updates
- [x] 45-04-PLAN.md -- Gap closure: winquist two-symbolic via TrivariateSeries, cross-validation

### Phase 46: Documentation
**Goal**: All new v3.0 features are documented in the PDF manual, help system, and worked examples reproducing Garvan's tutorial
**Depends on**: Phases 41-45
**Requirements**: DOC-01, DOC-02, DOC-03
**Plans**: 2 plans

Plans:
- [x] 46-01-PLAN.md -- Help entries for for/proc/if language constructs, tab completion keywords
- [x] 46-02-PLAN.md -- PDF manual scripting chapter with 3 worked examples, function count updates

## Milestone Summary

**Key Decisions:**
- BivariateSeries uses BTreeMap<i64, FPS> for Laurent polynomial representation
- TrivariateSeries uses BTreeMap<(i64,i64), FPS> for Winquist two-symbolic
- Language construct help uses special-case match arms before FUNC_HELP lookup
- Cyclotomic trial division scans from highest n down for correct factor discovery
- AST interception catches Compare(Eq) before evaluation so subs(q=1, expr) works
- Direct Pochhammer factor approach for winquist bivariate (not tripleprod decomposition)

**Issues Resolved:**
- Cross-validation test design: q-power monomials cause truncation boundary effects; switched to constant monomials
- Integer division returns Rational in q-Kangaroo; floor() needed for integer results in loops

**Issues Deferred:**
- zqfactor (BIVAR-07): bivariate rational function factoring deferred to future milestone
- quinprod prodid/seriesid identity display modes deferred
- While-loops (MAPLE-02), nops/op (MAPLE-03) deferred

**Technical Debt Incurred:**
- No add/sub/mul on TrivariateSeries -- only negate and display supported initially

---

_For current project status, see .planning/ROADMAP.md_
