---
phase: 51-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - manual/chapters/16-v4-changes.typ
  - manual/main.typ
  - manual/chapters/00-title.typ
  - manual/chapters/01-quick-start.typ
  - manual/chapters/02-installation.typ
  - manual/chapters/03-cli-usage.typ
  - manual/chapters/04-expression-language.typ
autonomous: true
requirements: [DOC-MANUAL]

must_haves:
  truths:
    - "PDF manual contains a v4.0 chapter documenting all 14 changes"
    - "v4.0 chapter organized by feature type: Language Features, Bug Fixes, New Functions"
    - "Walkthrough section reproduces all executable qmaple.pdf examples in REPL transcript style"
    - "Not Yet Supported subsection lists RootOf and while-loop examples"
    - "Function counts updated from 97 to 101 across all chapter files"
    - "qmaple.pdf referenced by section number and page"
  artifacts:
    - path: "manual/chapters/16-v4-changes.typ"
      provides: "Complete v4.0 chapter with language features, bug fixes, new functions, walkthrough, not-yet-supported"
      min_lines: 200
    - path: "manual/main.typ"
      provides: "#include for 16-v4-changes.typ"
      contains: "16-v4-changes"
  key_links:
    - from: "manual/main.typ"
      to: "manual/chapters/16-v4-changes.typ"
      via: "#include"
      pattern: "include.*16-v4-changes"
    - from: "manual/chapters/16-v4-changes.typ"
      to: "manual/template.typ"
      via: "#import"
      pattern: "import.*template"
---

<objective>
Create a new PDF manual chapter documenting all v4.0 changes with worked examples from qmaple.pdf, and update function counts across existing chapters.

Purpose: Users have a comprehensive reference for all 14 v4.0 features with REPL transcript examples that match the qmaple.pdf tutorial presentation. The manual accurately reflects the current function count of 101.
Output: New 16-v4-changes.typ chapter, updated main.typ and 5 existing chapter files.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-documentation/51-RESEARCH.md
@.planning/phases/46-documentation/46-02-SUMMARY.md
@manual/template.typ
@manual/main.typ
@manual/chapters/04b-scripting.typ
@manual/chapters/00-title.typ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v4.0 changes chapter (16-v4-changes.typ)</name>
  <files>manual/chapters/16-v4-changes.typ</files>
  <action>
  Create `manual/chapters/16-v4-changes.typ` following the established Typst patterns from 04b-scripting.typ. Use `#import "../template.typ": *` at top.

  Structure the chapter as follows (per user locked decision: organize by feature type):

  ```
  = What's New in v4.0
  #index[v4.0]

  Brief intro: v4.0 achieves full parity with Garvan's "A q-Product Tutorial for a q-Series Maple Package" (1998). This chapter documents all 14 changes and provides a walkthrough of the tutorial examples.

  == Language Features

  === Ditto Operator (")
  #index[ditto operator]
  - Explain: " references last printed result, equivalent to %
  - Example from qmaple.pdf Section 3.1 (p.5): aqprod then etamake with ditto
  - Use #repl-block for multi-line examples

  === Arrow Operator (->)
  #index[arrow operator]
  #index[lambda]
  - Explain: var -> expr creates anonymous function, desugars to proc
  - Example from qmaple.pdf Section 4.3 (p.15): F := q -> theta3(q, 500)/theta3(q^5, 100)
  - Show defining and calling the function

  === Fractional q-Powers
  #index[fractional powers]
  - Explain: theta2(q, T)/q^(1/4) and similar fractional exponent expressions
  - Example showing theta2 divided by q^(1/4)

  === Procedure Option/Local Reorder
  - Brief note: option remember and local can appear in either order in procedure definitions

  == Bug Fixes

  === aqprod 3-Argument Form
  #index[aqprod]
  - Explain: aqprod(a, q, n) now returns the full exact polynomial without truncation
  - Example: aqprod(q, q, 5) showing full polynomial

  === Theta 2-Argument Form
  #index[theta functions]
  - Explain: theta3(q, T) equivalent to theta3(q, q, T)
  - Example from qmaple.pdf Section 3.3 (p.8): theta2(q, 20), theta3(q, 20), theta4(q, 20)

  === qfactor 2-Argument Form
  #index[qfactor]
  - Explain: qfactor(f, T) equivalent to qfactor(f, q, T)
  - Example showing 2-arg qfactor

  === qfactor Product-Form Display
  - Explain: qfactor now displays (1-q)(1-q^2)... not raw struct
  - Example showing formatted output

  === etamake Eta-Notation Display
  #index[etamake]
  - Explain: etamake now displays eta(tau) * eta(2*tau)^5 ... not raw struct
  - Example from qmaple.pdf Section 3.3 (p.8-9)

  == New Functions

  Use #func-entry for each:

  === jac2series
  #func-entry with name, signature "jac2series(JP, T) or jac2series(JP, q, T)", description, params, examples from qmaple.pdf Section 3.4 (p.10-11)

  === radsimp
  #func-entry with name, signature "radsimp(expr)", description (identity function for compatibility), example from qmaple.pdf Section 4.5 (p.17-18)

  === quinprod Identity Modes
  #func-entry-style description of quinprod(z, q, "prodid") and quinprod(z, q, "seriesid") modes
  Examples from qmaple.pdf Section 6.2 (p.21-23)

  === Indexed subs
  Description of subs(X[1]=val, X[2]=val, expr) for indexed variable substitution
  Example from qmaple.pdf Section 4.3 (p.15-16): subs applied to findnonhom output

  == Walkthrough: qmaple.pdf Tutorial
  #index[qmaple.pdf tutorial]
  #index[Garvan tutorial]

  Reproduce ALL executable examples from Garvan's tutorial in the same order, referencing section and page. Use #repl-block for multi-line transcripts. Group by qmaple.pdf section:

  === Section 3: Product Conversion (p.5--11)
  Reference: Section 3.1 (p.5-6), Section 3.2 (p.6-8), Section 3.3 (p.8-9), Section 3.4 (p.10-11)

  Section 3.1 - prodmake examples:
  - Rogers-Ramanujan sum via for-loop, series, prodmake

  Section 3.2 - qfactor examples:
  - T(r,j) recursive procedure
  - Dixon sum procedure using min, qbin, RETURN
  - expand, factor, qfactor demonstrations

  Section 3.3 - etamake examples:
  - theta2(q, 20), theta3(q, 20), theta4(q, 20) with etamake
  - Note: Exercise 4 (RootOf) is in "Not Yet Supported"

  Section 3.4 - jacprodmake examples:
  - Rogers-Ramanujan jacprodmake, jac2prod, jac2series

  === Section 4: Relations (p.12--19)
  Reference each subsection by number and page.

  Section 4.1 - findhom: theta function homogeneous relations
  Section 4.2 - findhomcombo: Eisenstein series UE procedure
  Section 4.3 - findnonhom: theta quotient relations with arrow functions and indexed subs
  Section 4.4 - findnonhomcombo: eta quotient relations
  Section 4.5 - findpoly: theta/cubic modular identity with radsimp

  === Section 5: Sifting (p.19--20)
  - Ramanujan p(5n+4) identity using sift, etamake

  === Section 6: Product Identities (p.20--25)
  Section 6.1 - Triple product with symbolic z
  Section 6.2 - Quintuple product with prodid/seriesid modes
  Section 6.3 - Winquist with symbolic a/b, tripleprod

  For each example, show the q> command and expected output. Use REPL transcript style per user decision. Match qmaple.pdf presentation order per user decision.

  IMPORTANT: Verify each example output by running it through the actual CLI binary before including. Use:
  ```bash
  export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH"
  cargo run -p qsym-cli -- -c 'COMMAND' 2>&1
  ```

  === Not Yet Supported
  #index[unsupported features]
  List examples from qmaple.pdf that require features not yet in q-Kangaroo:
  - Exercise 4 (p.9): RootOf(z^2 + z + 1 = 0) -- requires algebraic number fields
  - while loops (deferred) -- no examples in the tutorial use while, but note it as a general limitation
  - with(qseries)/with(numtheory) -- Maple session commands, not needed (no-op)

  IMPORTANT: Examples must show commands + expected output in REPL transcript style per user locked decision. Reference qmaple.pdf by both section number and page per user locked decision. No raw Maple syntax -- all examples must be q-Kangaroo syntax.
  </action>
  <verify>
  ```bash
  # Verify the file exists and has expected structure
  wc -l C:/cygwin64/home/Owner/Kangaroo/manual/chapters/16-v4-changes.typ
  grep -c "repl-block\|repl(" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/16-v4-changes.typ
  grep -c "#index" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/16-v4-changes.typ
  grep "Section" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/16-v4-changes.typ | head -10
  ```
  File exists, has 200+ lines, contains multiple repl/repl-block examples, has index entries, references qmaple.pdf sections.
  </verify>
  <done>
  - 16-v4-changes.typ created with sections: Language Features, Bug Fixes, New Functions, Walkthrough, Not Yet Supported
  - All 14 v4.0 changes documented
  - Walkthrough reproduces all executable qmaple.pdf examples in order
  - qmaple.pdf referenced by section number and page throughout
  - REPL transcript style with q> prompts and expected output
  - Not Yet Supported lists RootOf and deferred features
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main.typ, function counts, and version in existing chapters</name>
  <files>manual/main.typ, manual/chapters/00-title.typ, manual/chapters/01-quick-start.typ, manual/chapters/02-installation.typ, manual/chapters/03-cli-usage.typ, manual/chapters/04-expression-language.typ</files>
  <action>
  **A. main.typ:** Add `#include "chapters/16-v4-changes.typ"` BEFORE the line `#include "chapters/15-appendix.typ"`. The appendix (index) must remain last.

  **B. Function count updates (97 -> 101):**

  Update "97" to "101" in these files:
  - `00-title.typ`: line 21, "all 97 built-in functions" -> "all 101 built-in functions"
  - `02-installation.typ`: line 69, "97 functions" -> "101 functions"
  - `03-cli-usage.typ`: line 129, "all 97 functions" -> "all 101 functions"
  - `04-expression-language.typ`: line 131, "97 built-in functions organized into 13 groups" -> "101 built-in functions organized into 15 groups" (13 + Simplification + Script Loading = 15)

  Also check `01-quick-start.typ` for any "97" references and update.

  **C. Function group update in 04-expression-language.typ:**

  After the existing 13 groups listing, add the two new groups:
  - Simplification (radsimp)
  - Script Loading (read)

  If there is an enumerated list of groups, add these two. Update the group count from 13 to 15.

  **D. Value type updates in 04-expression-language.typ:**

  If the chapter lists Value types, add any new types from v4.0:
  - FractionalPowerSeries (for fractional q-powers)
  - QProduct (for qfactor product-form display)
  - EtaQuotient (for etamake eta-notation display)

  These were added in Phases 47-49. Check if Phase 46 already added them; if not, add them.

  **E. Version string:** Leave template.typ version at "0.9.0" per Claude's discretion -- this is an internal version string, not the milestone name. (Could also be updated to "1.0.0" but the user didn't lock this.)
  </action>
  <verify>
  ```bash
  # Verify function count updates
  grep -n "101" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/00-title.typ
  grep -n "101" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/02-installation.typ
  grep -n "101" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/03-cli-usage.typ
  grep -n "101" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/04-expression-language.typ
  # Verify include
  grep "16-v4-changes" C:/cygwin64/home/Owner/Kangaroo/manual/main.typ
  # Verify no remaining "97" in function count context
  grep "97 built-in\|97 functions\|all 97" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/*.typ
  ```
  All files updated, no stale "97" references in function-count context. 16-v4-changes.typ included in main.typ.
  </verify>
  <done>
  - main.typ includes 16-v4-changes.typ before appendix
  - All function count references updated from 97 to 101 in 00-title, 01-quick-start (if applicable), 02-installation, 03-cli-usage, 04-expression-language
  - 04-expression-language lists 15 function groups (13 + Simplification + Script Loading)
  - New value types documented if not already present
  </done>
</task>

</tasks>

<verification>
```bash
# Verify new chapter exists and is substantial
wc -l C:/cygwin64/home/Owner/Kangaroo/manual/chapters/16-v4-changes.typ
# Verify main.typ has the include
grep "16-v4" C:/cygwin64/home/Owner/Kangaroo/manual/main.typ
# Verify no stale 97 counts
grep -rn "97 built\|97 functions\|all 97" C:/cygwin64/home/Owner/Kangaroo/manual/chapters/*.typ
# If typst is available, compile the manual
# typst compile manual/main.typ manual/q-kangaroo-manual.pdf
```
</verification>

<success_criteria>
- 16-v4-changes.typ exists with 200+ lines covering all 14 v4.0 changes
- Chapter organized by: Language Features, Bug Fixes, New Functions, Walkthrough, Not Yet Supported
- Walkthrough reproduces all executable qmaple.pdf examples (Sections 3-6) in REPL transcript style
- qmaple.pdf referenced by section number and page throughout
- Function counts updated from 97 to 101 across all chapter files
- 16-v4-changes.typ included in main.typ before appendix
- No stale "97" function count references remain
</success_criteria>

<output>
After completion, create `.planning/phases/51-documentation/51-02-SUMMARY.md`
</output>
