---
phase: 52-bug-fix-language-extensions
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-cli/src/eval.rs
  - crates/qsym-cli/src/commands.rs
autonomous: true
gap_closure: true
requirements: [LANG-01]

must_haves:
  truths:
    - "while true do 1 od hits the 1M safety limit and errors with max iteration count message"
    - "?while displays help text showing while...do...od syntax with examples"
    - "while false do 1 od still evaluates to nothing (no regression)"
  artifacts:
    - path: "crates/qsym-cli/src/eval.rs"
      provides: "is_truthy handles Symbol(true) and Symbol(false)"
      contains: 'Symbol'
    - path: "crates/qsym-cli/src/commands.rs"
      provides: "? prefix dispatches to Command::Help"
      contains: '?'
  key_links:
    - from: "crates/qsym-cli/src/eval.rs"
      to: "eval_while_loop"
      via: "is_truthy called on condition value"
      pattern: "is_truthy"
    - from: "crates/qsym-cli/src/commands.rs"
      to: "crates/qsym-cli/src/help.rs"
      via: "Command::Help(Some(topic)) dispatched by execute_command"
      pattern: "Command::Help"
---

<objective>
Close two UAT gaps from Phase 52: (1) `while true do 1 od` fails because `true` evaluates to
Value::Symbol("true") and is_truthy rejects symbols, and (2) `?while` shows nothing because
parse_command has no `?` prefix dispatch.

Purpose: Both fixes are required for Phase 52 acceptance -- the while-loop must handle bare `true`/`false` as conditions, and the `?topic` help shorthand must work.
Output: Two small code fixes with tests, both in existing files.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-bug-fix-language-extensions/52-02-SUMMARY.md
@crates/qsym-cli/src/eval.rs
@crates/qsym-cli/src/commands.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Handle Symbol("true"/"false") in is_truthy and add ? prefix to parse_command</name>
  <files>crates/qsym-cli/src/eval.rs, crates/qsym-cli/src/commands.rs</files>
  <action>
**Fix 1 -- is_truthy in eval.rs (around line 1247):**

Add a `Value::Symbol(s)` match arm to `is_truthy()`, between the existing `Value::Integer` arm and the `other =>` fallback:

```rust
Value::Symbol(s) => match s.as_str() {
    "true" => Ok(true),
    "false" => Ok(false),
    _ => Err(EvalError::Other(format!(
        "expected boolean or integer in condition, got symbol '{}'",
        s
    ))),
},
```

This makes `while true do ... od` work because `true` lexes as Ident, parses as Variable, evaluates to Symbol("true"), and now is_truthy accepts it. Unknown symbols like `while x do ... od` still error.

**Fix 2 -- ? prefix in commands.rs parse_command (around line 68):**

After the assignment check (line 72-74) and before the `words` split (line 76), add a check for the `?` prefix:

```rust
// ?topic -> help topic
if let Some(topic) = trimmed.strip_prefix('?') {
    let topic = topic.trim();
    if topic.is_empty() {
        return Some(Command::Help(None));
    } else {
        return Some(Command::Help(Some(topic.to_string())));
    }
}
```

This intercepts `?while`, `?aqprod`, `?` (bare) etc. and routes them to the help system. The existing help entry for "while" in help.rs will then be found and displayed.

Do NOT modify lexer.rs, parser.rs, or help.rs -- the fixes are entirely in eval.rs and commands.rs.
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /home/Owner/Kangaroo && cargo test -p qsym-cli 2>&1 | tail -5`
All existing tests must pass (no regressions).
  </verify>
  <done>is_truthy accepts Symbol("true") as truthy and Symbol("false") as falsy. parse_command("?while") returns Command::Help(Some("while")). All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for both fixes</name>
  <files>crates/qsym-cli/src/eval.rs, crates/qsym-cli/src/commands.rs</files>
  <action>
**Tests for is_truthy in eval.rs** -- add to the existing `#[cfg(test)] mod tests` block in eval.rs:

1. `test_is_truthy_symbol_true` -- evaluate `while true do break od` equivalent: call is_truthy with Value::Symbol("true".into()), assert Ok(true).
   Since is_truthy is a private function, test via eval: parse and eval `i:=0: while true do i:=i+1: if i>=5 then break fi od: i;` -- but break is not implemented. Instead, use the integration pattern: run eval_line on `i:=0: while true do i:=i+1: if i>5 then RETURN(i) fi od` -- but RETURN may not work in while.

   Simplest: test that `while false do 1 od` returns None (is_truthy(false) works), and that the full expression `i:=0: while true do i:=i+1: if i>=5 then i fi od` triggers the safety limit error with "maximum iteration" in the message. This proves is_truthy accepts Symbol("true").

   Concrete tests:
   ```rust
   #[test]
   fn while_symbol_true_hits_safety_limit() {
       // "true" is Symbol("true") -- is_truthy must accept it
       let mut env = Environment::new();
       let result = eval_line("while true do 1 od", &mut env);
       // Should hit 1M iteration limit, not "expected boolean or integer"
       assert!(result.is_err() || matches!(&result, Ok(s) if s.contains("iteration")),
           "expected safety limit error, got: {:?}", result);
   }

   #[test]
   fn while_symbol_false_does_not_execute() {
       let mut env = Environment::new();
       let result = eval_line("while false do 1 od", &mut env);
       // Symbol("false") is falsy -- body never executes
       assert!(result.is_ok(), "while false should succeed: {:?}", result);
   }
   ```

   Note: eval_line returns Result<String, ...>. The safety limit error from eval_while_loop returns an EvalError, which eval_line propagates as Err. Check that the Err message contains "iteration" (not "expected boolean").

**Tests for ? prefix in commands.rs** -- add to the existing `#[cfg(test)] mod tests` block:

```rust
#[test]
fn parse_question_mark_topic() {
    assert_eq!(
        parse_command("?while"),
        Some(Command::Help(Some("while".to_string())))
    );
}

#[test]
fn parse_question_mark_bare() {
    assert_eq!(parse_command("?"), Some(Command::Help(None)));
}

#[test]
fn parse_question_mark_with_spaces() {
    assert_eq!(
        parse_command("? aqprod"),
        Some(Command::Help(Some("aqprod".to_string())))
    );
}
```
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /home/Owner/Kangaroo && cargo test -p qsym-cli 2>&1 | tail -5`
All tests pass including new ones. Total test count should increase by ~5.
  </verify>
  <done>New tests confirm: (1) `while true do 1 od` hits safety limit (not "expected boolean" error), (2) `while false do 1 od` completes without error, (3) `?while` parses as Help("while"), (4) `?` alone parses as Help(None), (5) `? aqprod` parses as Help("aqprod"). All tests pass.</done>
</task>

</tasks>

<verification>
1. `cargo test -p qsym-cli` -- all tests pass (existing + new)
2. Manual spot-check: `echo "while true do 1 od" | cargo run -p qsym-cli --` should print error mentioning "maximum iteration" (not "expected boolean")
3. The ? prefix fix does not affect expression parsing because parse_command runs before the parser and only intercepts lines starting with `?`
</verification>

<success_criteria>
- `while true do 1 od` hits the 1,000,000 iteration safety limit and displays an error containing "maximum iteration count"
- `while false do 1 od` completes without error (body never runs)
- `?while` displays the while-loop help text (syntax and examples)
- `?` alone displays general help
- All existing tests pass (no regressions)
- 5+ new tests added
</success_criteria>

<output>
After completion, create `.planning/phases/52-bug-fix-language-extensions/52-03-SUMMARY.md`
</output>
