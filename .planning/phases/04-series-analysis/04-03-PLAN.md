---
phase: 04-series-analysis
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-core/src/qseries/linalg.rs
  - crates/qsym-core/src/qseries/mod.rs
  - crates/qsym-core/tests/qseries_linalg_tests.rs
autonomous: true

must_haves:
  truths:
    - "rational_null_space correctly finds the kernel of a known matrix over Q"
    - "rational_null_space returns empty vector for full-rank matrices"
    - "rational_null_space handles the zero matrix (all columns are free)"
    - "build_coefficient_matrix extracts correct FPS coefficients into matrix form"
  artifacts:
    - path: "crates/qsym-core/src/qseries/linalg.rs"
      provides: "Rational Gaussian elimination and null space computation over QRat"
      exports: ["rational_null_space", "build_coefficient_matrix"]
    - path: "crates/qsym-core/tests/qseries_linalg_tests.rs"
      provides: "Tests for null space on known matrices and coefficient matrix building"
      min_lines: 80
  key_links:
    - from: "crates/qsym-core/src/qseries/linalg.rs"
      to: "QRat"
      via: "exact rational arithmetic for pivot operations"
      pattern: "QRat::(zero|one|is_zero)"
    - from: "crates/qsym-core/src/qseries/linalg.rs"
      to: "FormalPowerSeries::coeff"
      via: "coefficient extraction for matrix building"
      pattern: "\\.coeff\\("
---

<objective>
Implement rational linear algebra (Gaussian elimination over QRat and null space computation) needed by all relation discovery functions.

Purpose: Every relation discovery function (findlincombo, findhom, findpoly, findcong, etc.) needs to build a coefficient matrix from series and find its null space over the rationals. This shared foundation (QSER-16 prerequisite) must be correct and well-tested before building any relation functions on top.
Output: linalg.rs with rational_null_space, build_coefficient_matrix, and thorough matrix tests.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-series-analysis/04-RESEARCH.md

@crates/qsym-core/src/number.rs
@crates/qsym-core/src/series/mod.rs
@crates/qsym-core/src/qseries/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement rational Gaussian elimination and null space</name>
  <files>
    crates/qsym-core/src/qseries/linalg.rs
    crates/qsym-core/src/qseries/mod.rs
  </files>
  <action>
Create `crates/qsym-core/src/qseries/linalg.rs`:

1. **`rational_null_space(matrix: &[Vec<QRat>]) -> Vec<Vec<QRat>>`**:
   - Input: m x n matrix (m rows, n columns) as slice of row vectors.
   - Algorithm: Row reduction to RREF (Reduced Row Echelon Form) over Q with exact arithmetic.
     - Copy matrix for in-place reduction.
     - Forward elimination with partial pivoting: for each column, find a row with nonzero entry, swap to pivot position, scale to make pivot = 1, eliminate all other entries in that column.
     - Track pivot columns.
   - Free variables: columns NOT in pivot_cols.
   - Build null space basis: for each free column fc, create vector with 1 in position fc and -a[i][fc] in each pivot position i.
   - Return list of basis vectors for ker(A).
   - Handle edge cases: empty matrix returns empty, matrix with 0 columns returns empty, full-rank matrix returns empty null space.

2. **`build_coefficient_matrix(candidates: &[&FormalPowerSeries], start_order: i64, num_rows: usize) -> Vec<Vec<QRat>>`**:
   - Each column is a candidate series, each row is a coefficient index.
   - Row i corresponds to exponent start_order + i.
   - Entry [i][j] = candidates[j].coeff(start_order + i as i64).
   - Ensure all candidate series have sufficient truncation order: start_order + num_rows <= min truncation.

3. **`modular_null_space(matrix: &[Vec<i64>], p: i64) -> Vec<Vec<i64>>`**:
   - Same algorithm but over Z/pZ. All arithmetic mod p.
   - Modular inverse via extended Euclidean algorithm (or Fermat's little theorem since p is prime).
   - `fn mod_inv(a: i64, p: i64) -> i64`: compute a^{p-2} mod p, or use extended gcd.
   - This is needed by the modp variants in Plan 06 but implement it now alongside rational version to share the structural pattern.

4. **Helper: `fn mod_pow(base: i64, exp: i64, modulus: i64) -> i64`** for modular exponentiation.

Update `crates/qsym-core/src/qseries/mod.rs`:
   - Add `pub mod linalg;`
   - Re-export: `pub use linalg::{rational_null_space, build_coefficient_matrix, modular_null_space};`
  </action>
  <verify>
`cargo build --manifest-path crates/qsym-core/Cargo.toml` compiles without errors.
  </verify>
  <done>
linalg.rs compiles with rational_null_space, build_coefficient_matrix, and modular_null_space all implemented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test linear algebra on known matrices</name>
  <files>
    crates/qsym-core/tests/qseries_linalg_tests.rs
  </files>
  <action>
Create test file `crates/qsym-core/tests/qseries_linalg_tests.rs`:

1. **Null space tests over Q**:
   - `test_null_space_identity`: 3x3 identity matrix -> null space is empty.
   - `test_null_space_rank_deficient`: Matrix [[1, 2, 3], [2, 4, 6]] has rank 1. Null space should have dimension 2. Verify that A * v = 0 for each basis vector v.
   - `test_null_space_single_relation`: Matrix [[1, 0, 1], [0, 1, 2], [1, 1, 3]] has rank 2. Null space should give [1, 2, -1] (or scalar multiple). Verify A * v = 0.
   - `test_null_space_empty_matrix`: Empty input -> empty null space.
   - `test_null_space_zero_matrix`: 2x3 zero matrix -> null space has dimension 3 (all columns free).
   - `test_null_space_rational_entries`: Matrix with QRat entries like [[1/2, 1/3], [1, 2/3]]. Verify exact rational null space (this matrix is full rank, so null space empty).

2. **build_coefficient_matrix tests**:
   - `test_build_coeff_matrix`: Create two known FPS (e.g., 1+q+q^2 and 1+2q+3q^2), build matrix from start_order=0, num_rows=3. Verify entries match.

3. **Modular null space tests**:
   - `test_modular_null_space_mod5`: Matrix [[1, 2], [3, 4]] mod 5. Determinant = -2 = 3 mod 5 != 0, so null space empty.
   - `test_modular_null_space_singular_mod7`: Matrix [[1, 2, 3], [2, 4, 6]] mod 7. Null space should have dimension 2.

4. **Verification helper**: For each null space test, verify that matrix * vector = 0 (the zero vector) for every returned basis vector.
  </action>
  <verify>
`cargo test --manifest-path crates/qsym-core/Cargo.toml --test qseries_linalg_tests` -- all tests pass.
  </verify>
  <done>
At least 8 tests passing covering rational null space (full rank, rank-deficient, edge cases), coefficient matrix building, and modular null space.
  </done>
</task>

</tasks>

<verification>
- `cargo build --manifest-path crates/qsym-core/Cargo.toml` succeeds
- `cargo test --manifest-path crates/qsym-core/Cargo.toml` -- all existing + new tests pass
- rational_null_space returns correct kernel basis verified by A*v=0 check
- build_coefficient_matrix extracts FPS coefficients correctly
</verification>

<success_criteria>
- Null space of identity matrix is empty
- Null space of rank-deficient matrix has correct dimension
- Every null space vector v satisfies A*v = 0 exactly (no approximation)
- Modular null space works correctly over Z/pZ
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-series-analysis/04-03-SUMMARY.md`
</output>
