---
phase: 04-series-analysis
plan: 06
type: execute
wave: 3
depends_on: ["04-02", "04-05"]
files_modified:
  - crates/qsym-core/src/qseries/relations.rs
  - crates/qsym-core/src/qseries/mod.rs
  - crates/qsym-core/tests/qseries_relations_tests.rs
autonomous: true

must_haves:
  truths:
    - "findcong discovers Ramanujan's congruence p(5n+4) = 0 mod 5"
    - "findnonhom finds non-homogeneous polynomial relations (degree <= d)"
    - "findhomcombo expresses a target series as a homogeneous degree-d combination of basis series"
    - "findnonhomcombo expresses a target series as a non-homogeneous degree <= d combination of basis series"
  artifacts:
    - path: "crates/qsym-core/src/qseries/relations.rs"
      provides: "findcong, findnonhom, findhomcombo, findnonhomcombo plus Congruence type"
      exports: ["findcong", "findnonhom", "findhomcombo", "findnonhomcombo", "Congruence"]
    - path: "crates/qsym-core/tests/qseries_relations_tests.rs"
      provides: "Tests for congruence discovery and combo variants"
      min_lines: 80
  key_links:
    - from: "crates/qsym-core/src/qseries/relations.rs (findcong)"
      to: "utilities::sift"
      via: "extract subsequence p(An+B) before testing divisibility"
      pattern: "use super::utilities::sift"
    - from: "crates/qsym-core/src/qseries/relations.rs (findnonhom)"
      to: "findhom monomial infrastructure"
      via: "reuses generate_monomials and compute_monomial_series from Plan 05, extended to degree <= d"
      pattern: "generate_monomials|compute_monomial_series"
    - from: "crates/qsym-core/src/qseries/relations.rs (findhomcombo)"
      to: "linalg::rational_null_space"
      via: "null space to find combo expressing f in terms of basis monomials"
      pattern: "rational_null_space"
---

<objective>
Implement findcong, findnonhom, findhomcombo, and findnonhomcombo -- the rational-arithmetic relation discovery extensions that generalize Plan 05's core functions (QSER-19 partial).

Purpose: findcong enables automated discovery of partition congruences (like Ramanujan's famous p(5n+4) = 0 mod 5). findnonhom extends findhom to non-homogeneous relations. The combo variants express a target series as a polynomial combination of basis series. These are all straightforward generalizations of Plan 05's findlincombo/findhom infrastructure.
Output: 4 new functions + Congruence struct added to relations.rs, with targeted tests.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-series-analysis/04-RESEARCH.md
@.planning/phases/04-series-analysis/04-02-SUMMARY.md
@.planning/phases/04-series-analysis/04-05-SUMMARY.md

@crates/qsym-core/src/qseries/relations.rs
@crates/qsym-core/src/qseries/utilities.rs
@crates/qsym-core/src/qseries/linalg.rs
@crates/qsym-core/src/qseries/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement findcong, findnonhom, findhomcombo, findnonhomcombo</name>
  <files>
    crates/qsym-core/src/qseries/relations.rs
    crates/qsym-core/src/qseries/mod.rs
  </files>
  <action>
Add to `crates/qsym-core/src/qseries/relations.rs`:

**Cross-module import required**: Add `use super::utilities::sift;` at the top of relations.rs so findcong can call the sift function from the utilities module (implemented in Plan 02).

1. **Congruence result type**:
   ```rust
   pub struct Congruence {
       pub modulus_m: i64,    // A in f(An+B)
       pub residue_b: i64,    // B in f(An+B)
       pub divisor_r: i64,    // R where f(An+B) = 0 mod R
   }
   ```

2. **`findcong(f: &FormalPowerSeries, moduli: &[i64]) -> Vec<Congruence>`**:
   - For each modulus m in moduli, for each residue j in 0..m:
     - Use sift(f, m, j) to extract the subsequence.
     - Check if all coefficients (up to available terms) are divisible by some R.
     - Try R = 2, 3, 5, 7, 11, ... and the modulus m itself.
     - If found, record Congruence { modulus_m: m, residue_b: j, divisor_r: R }.
   - Return all discovered congruences.

3. **`findnonhom(series: &[&FormalPowerSeries], degree: i64, topshift: i64) -> Vec<Vec<QRat>>`**:
   - Like findhom but generates ALL monomials of degree <= d (not just exactly d).
   - Include the constant monomial (all exponents 0 = the constant 1 series).
   - Otherwise same as findhom: build matrix, null space, return relations.
   - Reuses generate_monomials and compute_monomial_series helpers from Plan 05's findhom implementation. Call generate_monomials for each degree 0, 1, ..., d and concatenate.

4. **`findhomcombo(f: &FormalPowerSeries, basis: &[&FormalPowerSeries], degree: i64, topshift: i64) -> Option<Vec<QRat>>`**:
   - Express f as a homogeneous degree-d combination of the basis series.
   - Generate all degree-d monomials in basis.
   - Prepend f to the candidate list.
   - Build coefficient matrix, find null space vector with nonzero f-component.
   - Return the combination coefficients.

5. **`findnonhomcombo(f: &FormalPowerSeries, basis: &[&FormalPowerSeries], degree: i64, topshift: i64) -> Option<Vec<QRat>>`**:
   - Like findhomcombo but with monomials of degree <= d.

Update `crates/qsym-core/src/qseries/mod.rs`:
   - Add re-exports for all new functions and Congruence type.
  </action>
  <verify>
`cargo build --manifest-path crates/qsym-core/Cargo.toml` compiles without errors.
  </verify>
  <done>
All 4 functions compile and are re-exported. findcong correctly imports sift from utilities module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test congruence discovery and combo variants</name>
  <files>
    crates/qsym-core/tests/qseries_relations_tests.rs
  </files>
  <action>
Add tests to `crates/qsym-core/tests/qseries_relations_tests.rs`:

1. **findcong tests**:
   - `test_findcong_ramanujan_mod5`: Build partition_gf to high precision (O(q^200)). Run findcong(&pgf, &[5]). Should discover p(5n+4) = 0 mod 5 (Congruence { modulus_m: 5, residue_b: 4, divisor_r: 5 }).
   - `test_findcong_ramanujan_mod7`: Run findcong(&pgf, &[7]). Should discover p(7n+5) = 0 mod 7.
   - `test_findcong_ramanujan_mod11`: Run findcong(&pgf, &[11]). Should discover p(11n+6) = 0 mod 11.

2. **findnonhom tests**:
   - `test_findnonhom_affine_relation`: Create f, g where g = 2*f + 3 (affine, not homogeneous). findnonhom([f, g], 1, 0) should find the relation.

3. **findhomcombo tests**:
   - `test_findhomcombo_quadratic`: Create f = g1^2 + g2^2. findhomcombo(f, [g1, g2], 2, 0) should recover [1, 0, 1] (coefficients for g1^2, g1*g2, g2^2).

Keep test series small (truncation ~50) for fast execution. Use partition_gf at higher precision only for the Ramanujan congruence tests.
  </action>
  <verify>
`cargo test --manifest-path crates/qsym-core/Cargo.toml --test qseries_relations_tests` -- all tests pass (including Plan 05's tests).
  </verify>
  <done>
At least 5 new tests passing covering findcong (Ramanujan congruences mod 5, 7, 11), findnonhom, and findhomcombo. All prior Plan 05 relation tests still passing.
  </done>
</task>

</tasks>

<verification>
- `cargo build --manifest-path crates/qsym-core/Cargo.toml` succeeds
- `cargo test --manifest-path crates/qsym-core/Cargo.toml` -- all existing + new tests pass
- findcong discovers all three Ramanujan congruences (mod 5, 7, 11)
- findnonhom discovers non-homogeneous affine relations
- findhomcombo correctly expresses target as quadratic combination
</verification>

<success_criteria>
- findcong discovers p(5n+4) = 0 mod 5, p(7n+5) = 0 mod 7, p(11n+6) = 0 mod 11
- findnonhom discovers non-homogeneous relations
- findhomcombo and findnonhomcombo correctly express target series as polynomial combinations
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-series-analysis/04-06-SUMMARY.md`
</output>
