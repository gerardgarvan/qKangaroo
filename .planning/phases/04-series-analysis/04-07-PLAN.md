---
phase: 04-series-analysis
plan: 07
type: execute
wave: 4
depends_on: ["04-03", "04-05", "04-06"]
files_modified:
  - crates/qsym-core/src/qseries/relations.rs
  - crates/qsym-core/src/qseries/mod.rs
  - crates/qsym-core/tests/qseries_relations_tests.rs
autonomous: true

must_haves:
  truths:
    - "findlincombomodp discovers linear combinations mod a prime p"
    - "findhommodp finds homogeneous relations over Z/pZ"
    - "findhomcombomodp expresses target as homogeneous combo mod p"
    - "findmaxind identifies the maximal linearly independent subset of series"
    - "findprod searches for linear combinations that yield nice product forms"
  artifacts:
    - path: "crates/qsym-core/src/qseries/relations.rs"
      provides: "findlincombomodp, findhommodp, findhomcombomodp, findmaxind, findprod"
      exports: ["findlincombomodp", "findhommodp", "findhomcombomodp", "findmaxind", "findprod"]
    - path: "crates/qsym-core/tests/qseries_relations_tests.rs"
      provides: "Tests for modp variants, findmaxind, and findprod"
      min_lines: 80
  key_links:
    - from: "crates/qsym-core/src/qseries/relations.rs (modp variants)"
      to: "linalg::modular_null_space"
      via: "null space over Z/pZ for modular relation discovery"
      pattern: "modular_null_space"
    - from: "crates/qsym-core/src/qseries/relations.rs (findmaxind)"
      to: "linalg::rational_null_space"
      via: "rank computation to find independent subset"
      pattern: "rational_null_space"
    - from: "crates/qsym-core/src/qseries/relations.rs (findprod)"
      to: "prodmake::prodmake"
      via: "checks if linear combinations have nice product forms"
      pattern: "use super::prodmake::prodmake"
    - from: "crates/qsym-core/src/qseries/relations.rs (findhomcombomodp)"
      to: "findhomcombo"
      via: "modp variant of findhomcombo from Plan 06"
      pattern: "findhomcombo"
---

<objective>
Implement the modular arithmetic and search-based relation discovery functions: findlincombomodp, findhommodp, findhomcombomodp, findmaxind, and findprod -- completing the full QSER-19 relation discovery suite and achieving complete qseries package parity.

Purpose: The modp variants enable relation discovery over finite fields (critical for modular form theory where working mod p reveals structure invisible over Q). findmaxind identifies linearly independent subsets for basis selection. findprod searches for linear combinations with nice product representations. Together these complete all 12+ relation discovery functions.
Output: 5 new functions added to relations.rs, full test coverage, all qseries package parity achieved.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-series-analysis/04-RESEARCH.md
@.planning/phases/04-series-analysis/04-03-SUMMARY.md
@.planning/phases/04-series-analysis/04-05-SUMMARY.md
@.planning/phases/04-series-analysis/04-06-SUMMARY.md

@crates/qsym-core/src/qseries/relations.rs
@crates/qsym-core/src/qseries/linalg.rs
@crates/qsym-core/src/qseries/prodmake.rs
@crates/qsym-core/src/qseries/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement modp variants, findmaxind, and findprod</name>
  <files>
    crates/qsym-core/src/qseries/relations.rs
    crates/qsym-core/src/qseries/mod.rs
  </files>
  <action>
Add to `crates/qsym-core/src/qseries/relations.rs`:

**Cross-module imports required**:
- Add `use super::prodmake::prodmake;` so findprod can call prodmake to check if a linear combination has a nice product form.
- Ensure `use super::linalg::modular_null_space;` is present for the modp variants (modular_null_space was implemented in Plan 03).

1. **`findlincombomodp(f: &FormalPowerSeries, basis: &[&FormalPowerSeries], p: i64, topshift: i64) -> Option<Vec<i64>>`**:
   - Like findlincombo but working mod p.
   - Convert QRat coefficients to i64 mod p: for each coeff a/b, compute a * b^{-1} mod p. If b is divisible by p, skip (or handle error).
   - Build i64 matrix, use modular_null_space.
   - Return coefficients mod p.

2. **`findhommodp(series: &[&FormalPowerSeries], p: i64, degree: i64, topshift: i64) -> Vec<Vec<i64>>`**:
   - Like findhom but over Z/pZ.
   - Generate degree-d monomials, compute monomial series, convert coefficient matrix to mod p, use modular_null_space.

3. **`findhomcombomodp(f: &FormalPowerSeries, basis: &[&FormalPowerSeries], p: i64, degree: i64, topshift: i64) -> Option<Vec<i64>>`**:
   - Like findhomcombo but over Z/pZ.
   - Follows the same pattern as findhomcombo (Plan 06) but with modular arithmetic.

4. **`findmaxind(series: &[&FormalPowerSeries], topshift: i64) -> Vec<usize>`**:
   - Find the maximal linearly independent subset of the given series.
   - Build coefficient matrix with all series as columns.
   - Perform Gaussian elimination (or use null space), track pivot columns.
   - Pivot columns correspond to the independent series.
   - Return indices of independent series.

5. **`findprod(series: &[&FormalPowerSeries], max_coeff: i64, max_exp: i64) -> Vec<Vec<i64>>`**:
   - Search over integer linear combinations with coefficients bounded by max_coeff.
   - For each combination, compute the resulting series.
   - Use prodmake to check if the result has a "nice" product form (integer exponents).
   - Return combinations that yield nice products.
   - This is a brute-force search; use max_exp to bound the exponent vectors.
   - Optimization: use findlincombo with the product forms rather than exhaustive search.

Update `crates/qsym-core/src/qseries/mod.rs`:
   - Add re-exports for all new functions: findlincombomodp, findhommodp, findhomcombomodp, findmaxind, findprod.
  </action>
  <verify>
`cargo build --manifest-path crates/qsym-core/Cargo.toml` compiles without errors.
  </verify>
  <done>
All 5 functions compile and are re-exported. findprod correctly imports prodmake from prodmake module. modp variants correctly use modular_null_space from linalg module.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test modp variants, findmaxind, and findprod</name>
  <files>
    crates/qsym-core/tests/qseries_relations_tests.rs
  </files>
  <action>
Add tests to `crates/qsym-core/tests/qseries_relations_tests.rs`:

1. **findlincombomodp tests**:
   - `test_findlincombomodp`: Create known linear combination f = 3*g1 + 7*g2, verify discovery mod p=101. Should return [3, 7] (mod 101).

2. **findhommodp tests**:
   - `test_findhommodp_mod5`: Create series with a known degree-2 homogeneous relation. Verify findhommodp discovers it mod 5.

3. **findmaxind tests**:
   - `test_findmaxind_independent`: Three linearly independent series -> returns all three indices [0, 1, 2].
   - `test_findmaxind_dependent`: Three series where third is a combo of the first two -> returns two indices [0, 1].

4. **findprod tests**:
   - `test_findprod_simple`: Create two series where a linear combination equals a known product form. Verify findprod discovers the combination.

5. **Integration test**:
   - `test_full_suite_no_panic`: Run each of the 12+ relation discovery functions on simple inputs to verify no panics. This is a smoke test ensuring all functions are callable and return without error.

Keep test series small (truncation ~50) for fast execution.
  </action>
  <verify>
`cargo test --manifest-path crates/qsym-core/Cargo.toml --test qseries_relations_tests` -- all tests pass (including Plan 05 and Plan 06 tests).
  </verify>
  <done>
At least 5 new tests passing covering findlincombomodp, findhommodp, findmaxind (independent + dependent), and findprod. Full suite smoke test passes. All prior relation tests still passing. Phase 4 complete: all QSER-09 through QSER-19 requirements implemented.
  </done>
</task>

</tasks>

<verification>
- `cargo build --manifest-path crates/qsym-core/Cargo.toml` succeeds
- `cargo test --manifest-path crates/qsym-core/Cargo.toml` -- all existing + new tests pass
- findlincombomodp produces correct results mod p
- findmaxind correctly identifies independent subsets
- findprod discovers combinations yielding nice products
- Full suite of 12+ functions callable without error
</verification>

<success_criteria>
- findlincombomodp discovers known combinations mod p
- findmaxind correctly identifies linearly independent subsets
- findprod discovers combinations with nice product forms
- Full suite of 12+ functions callable without error
- All existing tests continue to pass
- Phase 4 complete: all QSER-09 through QSER-19 requirements implemented
</success_criteria>

<output>
After completion, create `.planning/phases/04-series-analysis/04-07-SUMMARY.md`
</output>
