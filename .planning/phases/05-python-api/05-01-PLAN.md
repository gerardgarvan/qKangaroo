---
phase: 05-python-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/qsym-python/Cargo.toml
  - crates/qsym-python/pyproject.toml
  - crates/qsym-python/src/lib.rs
  - crates/qsym-python/python/qsymbolic/__init__.py
autonomous: true

must_haves:
  truths:
    - "cdylib crate compiles successfully with GMP linked"
    - "Python can import the native module without errors"
    - "maturin develop builds and installs the wheel locally"
  artifacts:
    - path: "crates/qsym-python/Cargo.toml"
      provides: "cdylib crate configuration depending on qsym-core"
      contains: "crate-type = [\"cdylib\"]"
    - path: "crates/qsym-python/pyproject.toml"
      provides: "maturin build configuration with mixed layout"
      contains: "[tool.maturin]"
    - path: "crates/qsym-python/src/lib.rs"
      provides: "PyO3 module entry point"
      contains: "#[pymodule]"
    - path: "crates/qsym-python/python/qsymbolic/__init__.py"
      provides: "Pure Python package re-exporting from native module"
      contains: "from _qsymbolic import"
    - path: "Cargo.toml"
      provides: "Workspace includes qsym-python"
      contains: "qsym-python"
  key_links:
    - from: "crates/qsym-python/Cargo.toml"
      to: "crates/qsym-core/Cargo.toml"
      via: "path dependency"
      pattern: "qsym-core.*path.*=.*\"../qsym-core\""
    - from: "crates/qsym-python/src/lib.rs"
      to: "qsym_core"
      via: "use qsym_core"
      pattern: "use qsym_core"
---

<objective>
Scaffold the qsym-python crate and validate that a cdylib linking qsym-core (with GMP via rug) compiles and loads in Python.

Purpose: The GMP+cdylib build on Windows/Cygwin is the highest-risk item in Phase 5 (no prior art found). This plan validates the build works before any binding code is written, per research recommendation.

Output: A minimal but working `_qsymbolic` Python module that can be imported and returns a version string, proving the entire toolchain (Rust cdylib -> GMP linking -> maturin wheel -> Python import) works end-to-end.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-python-api/05-RESEARCH.md
@crates/qsym-core/Cargo.toml
@Cargo.toml
@.cargo/config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold qsym-python crate with Cargo.toml, pyproject.toml, and minimal pymodule</name>
  <files>
    Cargo.toml
    crates/qsym-python/Cargo.toml
    crates/qsym-python/pyproject.toml
    crates/qsym-python/src/lib.rs
    crates/qsym-python/python/qsymbolic/__init__.py
  </files>
  <action>
1. Create directory structure: `crates/qsym-python/src/` and `crates/qsym-python/python/qsymbolic/`.

2. Create `crates/qsym-python/Cargo.toml`:
   - `[package]` name = "qsym-python", version = "0.1.0", edition = "2024", rust-version = "1.85"
   - `[lib]` name = "_qsymbolic", crate-type = ["cdylib"]
   - `[dependencies]` pyo3 = { version = "0.23", features = ["extension-module"] }, qsym-core = { path = "../qsym-core" }
   - NOTE: Use PyO3 0.23 (not 0.28) for maximum compatibility per research recommendation. The frozen pyclass + Mutex patterns work identically.

3. Create `crates/qsym-python/pyproject.toml`:
   - build-system: requires = ["maturin>=1.0,<2.0"], build-backend = "maturin"
   - project: name = "qsymbolic", version = "0.1.0", requires-python = ">=3.9"
   - tool.maturin: features = ["pyo3/extension-module"], python-source = "python", module-name = "qsymbolic._qsymbolic"

4. Create `crates/qsym-python/src/lib.rs`:
   - A minimal `#[pymodule]` named `_qsymbolic` that registers one function: `version()` returning "0.1.0".
   - Import `qsym_core::ExprArena` and create+drop an arena in the `version()` function body to prove GMP linkage works at runtime (the arena uses rug which uses GMP).

5. Create `crates/qsym-python/python/qsymbolic/__init__.py`:
   - Import `version` from `._qsymbolic`
   - Set `__version__ = version()`
   - Set `__all__` = ["__version__"]

6. Update workspace `Cargo.toml` to add "crates/qsym-python" to members list.
  </action>
  <verify>
Run `cargo check -p qsym-python` with PATH set to include MinGW. This validates the cdylib compiles and GMP links without needing Python installed yet.
  </verify>
  <done>
`cargo check -p qsym-python` succeeds. All 5 files exist. The workspace Cargo.toml lists both crate members.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Python + maturin and validate end-to-end module import</name>
  <files></files>
  <action>
1. Check if Python 3.9+ is available. If not, install Python via the MinGW/MSYS2 package manager or direct download:
   - Try: `pacman -S mingw-w64-x86_64-python` (if MSYS2 pacman is available at /c/msys64/usr/bin/pacman or /c/mingw64-gcc/mingw64/bin/)
   - Or try: download Python installer from python.org and run silently
   - Or: check if there's a python3 already installed somewhere on the system by checking common paths like /c/Python3*, /c/Users/Owner/AppData/Local/Programs/Python/*
   - The key requirement is that `python3` (or `python`) is in PATH and is version 3.9+.

2. Install maturin: `pip install maturin` (or `pip3 install maturin`).

3. Run `maturin develop --release` from `crates/qsym-python/` directory. This:
   - Compiles the cdylib with GMP linkage
   - Packages it into a wheel
   - Installs it into the current Python environment

4. Validate: Run `python -c "import qsymbolic; print(qsymbolic.__version__)"`. Should print "0.1.0".

5. Validate GMP linkage at runtime: Run `python -c "from qsymbolic._qsymbolic import version; print(version())"`. Should print "0.1.0" (the version() function internally creates and drops an ExprArena which exercises GMP).

IMPORTANT: If Python installation or maturin fails, document the issue clearly. The build validation is the critical output of this plan. If `cargo check -p qsym-python` passed in Task 1 but maturin fails, that's still valuable information -- the cdylib compiles, the issue is in the Python toolchain integration.

If `use-system-libs` causes linking issues for the cdylib specifically, try removing the `use-system-libs` feature from qsym-core's gmp-mpfr-sys dependency to use the bundled GMP build instead. Document which approach works.
  </action>
  <verify>
`python -c "import qsymbolic; print(qsymbolic.__version__)"` prints "0.1.0". If Python is not installable in this environment, `cargo check -p qsym-python` passing is the minimum acceptable outcome (cdylib compiles).
  </verify>
  <done>
The cdylib compiles with GMP linked. Ideally, Python imports the module successfully. At minimum, `cargo check -p qsym-python` passes proving the Rust+GMP+cdylib toolchain works.
  </done>
</task>

</tasks>

<verification>
- `cargo check -p qsym-python` passes (cdylib compilation with GMP)
- Workspace Cargo.toml includes both crate members
- crates/qsym-python/ directory structure matches research layout
- If Python available: `python -c "import qsymbolic"` succeeds
</verification>

<success_criteria>
The cdylib crate compiles successfully linking qsym-core and GMP. The maturin/Python integration is validated if the environment supports it, or the build-blocks-only validation passes at minimum.
</success_criteria>

<output>
After completion, create `.planning/phases/05-python-api/05-01-SUMMARY.md`
</output>
