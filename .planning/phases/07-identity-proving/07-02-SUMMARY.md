---
phase: 07-identity-proving
plan: "02"
subsystem: qseries
tags: [cusps, modular-forms, ligozat, euler-phi, gamma0, eta-quotient]

# Dependency graph
requires:
  - phase: 07-identity-proving
    provides: "EtaExpression struct with factors, level, q_shift(), weight(), check_modularity()"
provides:
  - "Cusp struct for cusp representation (a/c with gcd normalization)"
  - "cuspmake(N) enumerating inequivalent cusps of Gamma_0(N)"
  - "cuspmake1(N) enumerating cusps of Gamma_1(N)"
  - "num_cusps_gamma0(N) cusp count via sum_{d|N} phi(gcd(d,N/d))"
  - "eta_order_at_cusp (invariant cuspord via Ligozat formula)"
  - "cusp_width computing N/gcd(c^2,N)"
  - "total_order weighted sum of orders across all cusps"
  - "gcd and euler_phi as pub(crate) helpers"
affects: [07-03-prove, 07-04-database, identity-proving]

# Tech tracking
tech-stack:
  added: []
  patterns: ["cuspord invariant order = sum gcd(c,delta)^2*r/(24*delta)", "infinity represents c=N cusp class", "weighted order = cuspord * width"]

key-files:
  created:
    - "crates/qsym-core/src/qseries/identity/cusps.rs"
    - "crates/qsym-core/src/qseries/identity/orders.rs"
    - "crates/qsym-core/tests/qseries_identity_cusps_tests.rs"
  modified:
    - "crates/qsym-core/src/qseries/identity/mod.rs"
    - "crates/qsym-core/src/qseries/mod.rs"

key-decisions:
  - "Cusp 0/1 generated by d=0 for c=1; infinity represents the c=N equivalence class"
  - "Invariant order (cuspord) = sum gcd(c,delta)^2*r_delta/(24*delta) -- no N/24 prefactor or gcd(c,N/c) divisor"
  - "Weighted order (cuspORD) = cuspord * cusp_width; sum of cuspORDs = 0 for weight-0 eta quotients"

patterns-established:
  - "cuspmake: infinity + loop over divisors c < N with d in 0..c"
  - "Order formula convention: eta_order_at_cusp returns invariant order, total_order returns weighted sum"

# Metrics
duration: 11min
completed: 2026-02-14
---

# Phase 7 Plan 2: Cusp Computation and Order-at-Cusp Formulas Summary

**Cusp enumeration for Gamma_0(N)/Gamma_1(N) and Ligozat cuspord formula with exact QRat arithmetic, verified across 50 levels and 30+ eta quotients**

## Performance

- **Duration:** 11 min
- **Started:** 2026-02-14T17:16:41Z
- **Completed:** 2026-02-14T17:27:47Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments
- Cusp enumeration for Gamma_0(N) matching the formula sum_{d|N} phi(gcd(d,N/d)) for all N=1..50
- Ligozat invariant order formula (cuspord) with exact QRat arithmetic, confirmed by total weighted order = 0 across 30+ weight-0 eta quotients on 6 different prime levels
- Cusp width sum = index of Gamma_0(N) verified for N=1..30
- 36 integration tests providing thorough coverage of cusp computation, order formulas, and structural invariants

## Task Commits

Each task was committed atomically:

1. **Task 1: Cusp struct and cuspmake algorithms** - `1173807` (feat)
2. **Task 2: Order-at-cusp computation via Ligozat formula** - `50427b5` (feat)
3. **Task 3: Integration tests for cusp computation and orders** - `8fda9f2` (test)

## Files Created/Modified
- `crates/qsym-core/src/qseries/identity/cusps.rs` - Cusp struct, cuspmake, cuspmake1, num_cusps_gamma0, gcd, euler_phi
- `crates/qsym-core/src/qseries/identity/orders.rs` - eta_order_at_cusp (Ligozat cuspord), cusp_width, total_order
- `crates/qsym-core/src/qseries/identity/mod.rs` - Module declarations and re-exports for cusps and orders
- `crates/qsym-core/src/qseries/mod.rs` - Top-level re-exports for Cusp, cuspmake, cuspmake1, etc.
- `crates/qsym-core/tests/qseries_identity_cusps_tests.rs` - 36 integration tests

## Decisions Made
- **Cusp convention:** Infinity (1/0) represents the cusp class for denominator c=N. The cusp at 0 is explicitly 0/1 with c=1. The cuspmake loop iterates d from 0 to c-1 (not 1 to c-1) for each divisor c < N.
- **Invariant order formula:** cuspord = sum_{delta} gcd(c,delta)^2 * r_delta / (24*delta). This is the Garvan cuspord formula, NOT the Ligozat formula with N/24 prefactor and gcd(c,N/c) divisor that was specified in the plan. The plan's formula was incorrect.
- **Weighted vs invariant:** eta_order_at_cusp returns the invariant order. total_order returns the sum of width*order (weighted sum). The proving engine (Plan 07-03) will use invariant orders for the non-negativity check.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed cuspmake algorithm: missing cusp 0/1 and incorrect c=N handling**
- **Found during:** Task 3 (integration tests)
- **Issue:** The plan specified d in 1..c with c > 1, which missed the cusp 0/1 (d=0, c=1) and included the cusp 1/N which is Gamma_0(N)-equivalent to infinity, producing incorrect cusp counts for N >= 9
- **Fix:** Changed algorithm to: infinity represents c=N class; loop c over divisors with c < N; loop d from 0 to c-1. For c=1, d=0 gives cusp 0/1 correctly. gcd(0,1)=1 passes the coprimality check.
- **Files modified:** crates/qsym-core/src/qseries/identity/cusps.rs
- **Verification:** cuspmake count matches num_cusps_gamma0 for all N=1..50
- **Committed in:** 8fda9f2 (Task 3 commit)

**2. [Rule 1 - Bug] Fixed Ligozat formula: removed incorrect N/24 and gcd(c,N/c) factors**
- **Found during:** Task 3 (integration tests)
- **Issue:** The plan specified cuspord = (N/24) * sum[gcd(c,delta)^2 * r / (gcd(c,N/c) * c * delta)] but this produced incorrect total weighted orders (not zero for weight-0 functions). The correct Garvan cuspord formula is simply sum[gcd(c,delta)^2 * r / (24*delta)] with no extra factors.
- **Fix:** Removed the N/24 prefactor and gcd(c,N/c) divisor from the formula
- **Files modified:** crates/qsym-core/src/qseries/identity/orders.rs
- **Verification:** total_order = 0 for weight-0 eta quotients on levels 4, 5, 6, 7, 12, 25 and systematically for 30 combinations
- **Committed in:** 8fda9f2 (Task 3 commit)

**3. [Rule 1 - Bug] Removed incorrect +/- equivalence in cuspmake**
- **Found during:** Task 3 (integration tests)
- **Issue:** The plan specified that cusps d1/c and d2/c are equivalent if d1 = +/-d2 mod gcd(c,N/c). This +/- folding was wrong for Gamma_0(N) and produced too few cusps.
- **Fix:** Removed the r_neg check; equivalence is simply d1 = d2 mod gcd(c,N/c)
- **Files modified:** crates/qsym-core/src/qseries/identity/cusps.rs
- **Verification:** Count matches formula for all N=1..50
- **Committed in:** 8fda9f2 (Task 3 commit)

---

**Total deviations:** 3 auto-fixed (3 bugs in plan's mathematical formulas)
**Impact on plan:** All fixes necessary for mathematical correctness. The plan's formulas contained errors that were caught and corrected during testing. No scope creep.

## Issues Encountered
- The research document and plan contained an incorrect version of the Ligozat formula. The correct formula was deduced by verifying against the known invariant: total weighted order = 0 for weight-0 eta quotients. This required careful analysis of Garvan's cuspord vs the academic Ligozat formula, and understanding the distinction between invariant order and weighted order.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Cusp enumeration and order computation are complete and tested, ready for the proving engine (Plan 07-03)
- Plan 07-03 will use: cuspmake to enumerate cusps, eta_order_at_cusp to check non-negativity at each cusp, and total_order as a sanity check
- Key API: `cuspmake(N) -> Vec<Cusp>`, `eta_order_at_cusp(&EtaExpression, &Cusp) -> QRat`, `cusp_width(N, &Cusp) -> i64`

## Self-Check: PASSED

- [x] cusps.rs exists
- [x] orders.rs exists
- [x] qseries_identity_cusps_tests.rs exists
- [x] 07-02-SUMMARY.md exists
- [x] Commit 1173807 (Task 1) in git log
- [x] Commit 50427b5 (Task 2) in git log
- [x] Commit 8fda9f2 (Task 3) in git log
- [x] All 36 tests pass
- [x] No regressions in existing test suite

---
*Phase: 07-identity-proving*
*Completed: 2026-02-14*
