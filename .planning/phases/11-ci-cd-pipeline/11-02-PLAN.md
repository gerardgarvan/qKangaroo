---
phase: 11-ci-cd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "Pushing a version tag (v*) triggers wheel builds for Linux and Windows"
    - "Linux wheel is manylinux2014 x86_64 with GMP linked"
    - "Windows wheel is win_amd64 GNU-compiled with libgmp-10.dll bundled"
    - "Source distribution (sdist) is built alongside wheels"
    - "All artifacts are published to PyPI via OIDC trusted publishing"
    - "No API tokens are stored in repository secrets for PyPI publishing"
  artifacts:
    - path: ".github/workflows/release.yml"
      provides: "Release workflow with linux-wheels, windows-wheels, sdist, and publish jobs"
      contains: "tags:"
  key_links:
    - from: ".github/workflows/release.yml (linux-wheels)"
      to: "manylinux2014 container"
      via: "maturin-action with before-script-linux: yum install gmp-devel"
      pattern: "gmp-devel"
    - from: ".github/workflows/release.yml (windows-wheels)"
      to: "MSYS2 MinGW GMP"
      via: "msys2/setup-msys2 with mingw-w64-x86_64-gmp"
      pattern: "mingw-w64-x86_64-gmp"
    - from: ".github/workflows/release.yml (publish)"
      to: "PyPI"
      via: "pypa/gh-action-pypi-publish with id-token: write and environment: pypi"
      pattern: "gh-action-pypi-publish"
    - from: ".github/workflows/release.yml (publish)"
      to: "wheels-linux, wheels-windows, wheels-sdist artifacts"
      via: "download-artifact with pattern: wheels-*"
      pattern: "merge-multiple"

user_setup:
  - service: pypi
    why: "OIDC trusted publishing for automated PyPI releases"
    env_vars: []
    dashboard_config:
      - task: "Configure trusted publisher on PyPI"
        location: "https://pypi.org/manage/project/q-kangaroo/settings/publishing/"
        details: "Add trusted publisher: owner/q-kangaroo repo, release.yml workflow, pypi environment"
  - service: github
    why: "Repository environment for PyPI OIDC"
    env_vars: []
    dashboard_config:
      - task: "Create 'pypi' environment in repository settings"
        location: "Repository Settings -> Environments -> New environment -> 'pypi'"
        details: "Required for OIDC trusted publishing. No secrets needed."
  - service: codecov
    why: "Coverage reporting and badge (referenced by Plan 01 README badge)"
    env_vars:
      - name: CODECOV_TOKEN
        source: "Codecov.io -> Settings -> Repository -> Upload Token (add as GitHub repo secret)"
    dashboard_config:
      - task: "Add repository to Codecov"
        location: "https://app.codecov.io/ -> Add new repository"
        details: "Sign in with GitHub, authorize Codecov, add the q-kangaroo repository"
---

<objective>
Create the release workflow (.github/workflows/release.yml) that builds manylinux2014 Linux wheels, MinGW Windows wheels with bundled GMP DLL, and source distribution when a version tag is pushed, then publishes all artifacts to PyPI via OIDC trusted publishing.

Purpose: Tagged releases automatically produce platform-specific wheels and publish to PyPI with zero manual intervention and no stored API tokens.
Output: `.github/workflows/release.yml`
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ci-cd-pipeline/11-RESEARCH.md
@.planning/phases/11-ci-cd-pipeline/11-01-SUMMARY.md
@crates/qsym-python/pyproject.toml
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create release workflow with Linux wheel build, sdist, and publish jobs</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create `.github/workflows/release.yml` with the following structure:

**Trigger:** `push: tags: ['v*']`
**Top-level:** `permissions: contents: read`, `env: CARGO_TERM_COLOR: always`

**Job 1: linux-wheels**
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/checkout@v4`
  2. `PyO3/maturin-action@v1` with:
     - `command: build`
     - `args: --release`
     - `working-directory: crates/qsym-python`
     - `manylinux: 2014`
     - `before-script-linux: yum install -y gmp-devel`
     - env: `PYO3_USE_ABI3_FORWARD_COMPATIBILITY: '1'`
  3. `actions/upload-artifact@v4` with `name: wheels-linux`, `path: crates/qsym-python/target/wheels/*.whl`

**Note on wheel output path:** Since a workspace Cargo.toml exists at the repo root, maturin targets `./target/wheels/` regardless of `working-directory`. Use `path: target/wheels/*.whl` for upload. If CI shows an empty artifact, try `crates/qsym-python/target/wheels/*.whl` as fallback.

**Job 2: sdist**
- `runs-on: ubuntu-latest`
- Steps:
  1. `actions/checkout@v4`
  2. `PyO3/maturin-action@v1` with `command: sdist`, `working-directory: crates/qsym-python`
  3. `actions/upload-artifact@v4` with `name: wheels-sdist`, `path: target/wheels/*.tar.gz`

**Job 3: publish**
- `needs: [linux-wheels, windows-wheels, sdist]`
- `runs-on: ubuntu-latest`
- `environment: name: pypi, url: https://pypi.org/p/q-kangaroo`
- `permissions: id-token: write` (job-level, NOT workflow-level)
- Steps:
  1. `actions/download-artifact@v4` with `pattern: wheels-*`, `merge-multiple: true`, `path: dist/`
  2. `pypa/gh-action-pypi-publish@release/v1`

**Job 3: windows-wheels**
- `runs-on: windows-latest`
- Steps:
  1. `run: git config --global core.autocrlf input` (shell: bash, BEFORE checkout to prevent line ending issues)
  2. `actions/checkout@v4`
  3. `msys2/setup-msys2@v2` with `msystem: MINGW64`, `update: false`, `install: mingw-w64-x86_64-gcc mingw-w64-x86_64-gmp`
  4. `dtolnay/rust-toolchain@stable` with `targets: x86_64-pc-windows-gnu`
  5. `actions/setup-python@v5` with `python-version: '3.12'`
  6. Copy GMP DLL: `shell: msys2 {0}`, `run: cp /mingw64/bin/libgmp-10.dll crates/qsym-python/python/q_kangaroo/`
  7. Check for additional MinGW DLLs needed: `shell: msys2 {0}`, run ldd-like check on libgmp-10.dll. Actually, skip this -- the Phase 10 wheel verification found 5 DLLs bundled (libgmp-10, libmpfr-6, libmpc-3, libgcc_s_seh-1, libwinpthread-1). Copy ALL of them:
     ```
     cp /mingw64/bin/libgmp-10.dll crates/qsym-python/python/q_kangaroo/
     cp /mingw64/bin/libgcc_s_seh-1.dll crates/qsym-python/python/q_kangaroo/
     cp /mingw64/bin/libwinpthread-1.dll crates/qsym-python/python/q_kangaroo/
     ```
     Note: libmpfr-6.dll and libmpc-3.dll may not be needed on CI since we use `use-system-libs` (they were bundled in local build because they existed in the MinGW directory and matched the *.dll glob). Only copy the DLLs that the .pyd actually depends on. To be safe, copy libgmp-10.dll, libgcc_s_seh-1.dll, and libwinpthread-1.dll (these are the runtime deps). The pyproject.toml `include` pattern `python/q_kangaroo/*.dll` will pick them all up.
  8. Add MSYS2 to system PATH for the linker: `shell: bash`, `run: echo "D:/a/_temp/msys64/mingw64/bin" >> $GITHUB_PATH`
     Better: use the msys2 step id output. Give the msys2 step an `id: msys2` and reference `${{ steps.msys2.outputs.msys2-location }}`. BUT the setup-msys2 action may not expose this output. Use the known path `D:/a/_temp/msys64/mingw64/bin` as the research suggests, or set `LIBRARY_PATH` and `C_INCLUDE_PATH` env vars.
     Safest approach: Set env vars on the build step: `LIBRARY_PATH: D:/a/_temp/msys64/mingw64/lib`, `C_INCLUDE_PATH: D:/a/_temp/msys64/mingw64/include`
  9. Build wheel: Use `PyO3/maturin-action@v1` with `command: build`, `args: --release --target x86_64-pc-windows-gnu`, `working-directory: crates/qsym-python`, env `PYO3_USE_ABI3_FORWARD_COMPATIBILITY: '1'`
     Also set `LIBRARY_PATH` and `C_INCLUDE_PATH` in the env for this step.
  10. `actions/upload-artifact@v4` with `name: wheels-windows`, `path: target/wheels/*.whl`

**Job 4: publish** (as described above, with `needs: [linux-wheels, windows-wheels, sdist]`)
  </action>
  <verify>
Validate the YAML:
- Proper 2-space indentation throughout
- Trigger is on push tags ['v*']
- Four jobs exist: linux-wheels, windows-wheels, sdist, publish
- linux-wheels uses maturin-action with manylinux: 2014 and before-script-linux for GMP
- windows-wheels uses msys2/setup-msys2 with MinGW GMP, GNU Rust target, DLL copy step
- sdist uses maturin-action with command: sdist
- publish job has `needs: [linux-wheels, windows-wheels, sdist]`
- publish job has `permissions: id-token: write` at JOB level (not workflow level)
- publish job has `environment: name: pypi`
- publish uses pypa/gh-action-pypi-publish@release/v1
- publish downloads artifacts with `pattern: wheels-*` and `merge-multiple: true`
- PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1 set on both wheel build jobs
- All action versions pinned (@v4, @v5, @stable, @v1, @v2)
  </verify>
  <done>
.github/workflows/release.yml exists with four jobs (linux-wheels, windows-wheels, sdist, publish) triggered on version tags. Linux uses manylinux2014 with GMP, Windows uses MSYS2 MinGW with bundled DLLs, publish uses OIDC trusted publishing with no stored tokens.
  </done>
</task>

<task type="checkpoint:human-verify" gate="non-blocking">
  <name>Task 2: Verify workflow files are syntactically valid and logically complete</name>
  <what-built>Two GitHub Actions workflow files: ci.yml (testing + coverage on push/PR) and release.yml (wheel builds + PyPI publish on version tags). These cover all 7 CI requirements (CI-01 through CI-07).</what-built>
  <how-to-verify>
1. Review `.github/workflows/ci.yml`:
   - Confirm three jobs: rust-tests, python-tests, coverage
   - Confirm triggers: push to main + pull_request
   - Confirm GMP installation in all jobs

2. Review `.github/workflows/release.yml`:
   - Confirm four jobs: linux-wheels, windows-wheels, sdist, publish
   - Confirm trigger: push tags v*
   - Confirm OIDC publish (id-token: write, environment: pypi, no API tokens)
   - Confirm Windows DLL copy step before wheel build

3. Before first real CI run, you will need to:
   - Push the repo to GitHub (owner/q-kangaroo)
   - Add CODECOV_TOKEN secret to repository settings
   - Create 'pypi' environment in repository settings
   - Configure trusted publisher on PyPI project settings

4. The first real validation happens when you push to GitHub and observe the Actions tab. These files are correct based on the research and standard patterns, but CI workflows always need a live test.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 11 Plan 02 verification:
1. `.github/workflows/release.yml` exists and contains valid YAML with 4 jobs
2. release.yml triggers only on version tags (v*)
3. linux-wheels job uses maturin-action with manylinux2014 and GMP
4. windows-wheels job uses MSYS2 MinGW with GNU Rust target and DLL bundling
5. sdist job produces source distribution
6. publish job uses OIDC trusted publishing (id-token: write, environment: pypi)
7. No API tokens stored anywhere -- pure OIDC
8. Artifact naming is unique per job (wheels-linux, wheels-windows, wheels-sdist)
9. Publish job downloads all artifacts with merge-multiple pattern
</verification>

<success_criteria>
- Release workflow created at `.github/workflows/release.yml`
- Four jobs defined: linux-wheels, windows-wheels, sdist, publish
- Linux wheel uses manylinux2014 container with GMP (CI-03)
- Windows wheel uses MSYS2 MinGW with bundled DLLs (CI-04)
- Publish uses OIDC trusted publishing, no API tokens (CI-06, CI-07)
- Version tag trigger ensures only tagged releases publish (CI-06)
- Requirements CI-03, CI-04, CI-06, CI-07 are covered
</success_criteria>

<output>
After completion, create `.planning/phases/11-ci-cd-pipeline/11-02-SUMMARY.md`
</output>
