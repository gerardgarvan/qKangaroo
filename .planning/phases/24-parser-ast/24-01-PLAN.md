---
phase: 24-parser-ast
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - crates/qsym-cli/Cargo.toml
  - crates/qsym-cli/src/main.rs
  - crates/qsym-cli/src/lib.rs
  - crates/qsym-cli/src/ast.rs
  - crates/qsym-cli/src/token.rs
  - crates/qsym-cli/src/error.rs
autonomous: true
requirements:
  - PARSE-04

must_haves:
  truths:
    - "qsym-cli crate compiles as a workspace member alongside qsym-core and qsym-python"
    - "AST types represent all Maple-style constructs: Integer, BigInteger, Q, Infinity, LastResult, Variable, BinOp, Neg, FuncCall, Assign"
    - "Token types cover the full grammar: Integer, BigInteger, Infinity, Q, Ident, Plus, Minus, Star, Slash, Caret, Assign, Percent, LParen, RParen, Comma, Semi, Colon, Eof"
    - "Span and SpannedToken carry byte offset information for error reporting"
    - "ParseError has a render method that produces caret-style error messages"
  artifacts:
    - path: "Cargo.toml"
      provides: "Workspace with qsym-cli member"
      contains: "qsym-cli"
    - path: "crates/qsym-cli/Cargo.toml"
      provides: "Binary crate depending on qsym-core"
      contains: "qsym-core"
    - path: "crates/qsym-cli/src/ast.rs"
      provides: "AstNode, BinOp, Terminator, Stmt types"
      exports: ["AstNode", "BinOp", "Terminator", "Stmt"]
    - path: "crates/qsym-cli/src/token.rs"
      provides: "Token, Span, SpannedToken types"
      exports: ["Token", "Span", "SpannedToken"]
    - path: "crates/qsym-cli/src/error.rs"
      provides: "ParseError type with render method"
      exports: ["ParseError"]
  key_links:
    - from: "crates/qsym-cli/src/lib.rs"
      to: "ast.rs, token.rs, error.rs"
      via: "pub mod declarations"
      pattern: "pub mod (ast|token|error)"
    - from: "crates/qsym-cli/src/error.rs"
      to: "crates/qsym-cli/src/token.rs"
      via: "uses Span type"
      pattern: "use crate::token::Span"
---

<objective>
Create the qsym-cli crate scaffold with AST node types, token types, span/error types, and verify it compiles as a workspace member.

Purpose: Establishes the foundational type definitions that the lexer and parser (Plan 24-02) build upon. The AST is independent of qsym-core's Expr type -- it represents syntax (what the user typed), not semantics (mathematical structure).

Output: Compilable qsym-cli crate with complete type definitions for the Maple-style grammar.
</objective>

<execution_context>
@C:/Users/Owner/.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-parser-ast/24-RESEARCH.md
@Cargo.toml
@crates/qsym-core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create qsym-cli crate with Cargo.toml and workspace registration</name>
  <files>
    Cargo.toml
    crates/qsym-cli/Cargo.toml
    crates/qsym-cli/src/main.rs
    crates/qsym-cli/src/lib.rs
  </files>
  <action>
1. Create directory `crates/qsym-cli/src/`.

2. Create `crates/qsym-cli/Cargo.toml`:
   - `[package]` name = "qsym-cli", version = "0.1.0", edition = "2021"
   - `[[bin]]` name = "q-kangaroo", path = "src/main.rs"
   - `[dependencies]` qsym-core = { path = "../qsym-core" }
   - No other dependencies needed for Phase 24

3. Update workspace `Cargo.toml` (project root):
   - Add `"crates/qsym-cli"` to the `members` list

4. Create `crates/qsym-cli/src/main.rs`:
   - Minimal entry point: `fn main() { println!("q-Kangaroo REPL (not yet implemented)"); }`
   - This will be expanded in Phase 26 (REPL shell)

5. Create `crates/qsym-cli/src/lib.rs`:
   - Declare public modules: `pub mod ast;`, `pub mod token;`, `pub mod error;`
   - These modules will be created in Task 2
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /c/cygwin64/home/Owner/Kangaroo && cargo check -p qsym-cli 2>&1`
Must show "Checking qsym-cli" and succeed (exit 0). No errors.
  </verify>
  <done>qsym-cli crate is a workspace member, compiles, and the binary target is named "q-kangaroo".</done>
</task>

<task type="auto">
  <name>Task 2: Define AST, Token, Span, and Error types</name>
  <files>
    crates/qsym-cli/src/ast.rs
    crates/qsym-cli/src/token.rs
    crates/qsym-cli/src/error.rs
  </files>
  <action>
1. Create `crates/qsym-cli/src/token.rs`:
   - `Token` enum with variants:
     - `Integer(i64)` -- fits in i64
     - `BigInteger(String)` -- overflow fallback for numbers > i64::MAX
     - `Infinity` -- the `infinity` keyword
     - `Q` -- the `q` keyword (reserved, not a variable)
     - `Ident(String)` -- function names (aqprod, etaq, ETAR) and user variables (f, g)
     - `Plus`, `Minus`, `Star`, `Slash`, `Caret` -- arithmetic operators
     - `Assign` -- the `:=` two-character token
     - `Percent` -- `%` ditto operator
     - `LParen`, `RParen`, `Comma` -- delimiters
     - `Semi`, `Colon` -- statement terminators
     - `Eof` -- end of input
   - Derive `Debug, Clone, PartialEq` on Token
   - `Span` struct: `{ pub start: usize, pub end: usize }` (byte offsets)
   - Derive `Debug, Clone, Copy, PartialEq` on Span
   - `SpannedToken` struct: `{ pub token: Token, pub span: Span }`
   - Derive `Debug, Clone` on SpannedToken

2. Create `crates/qsym-cli/src/ast.rs`:
   - `BinOp` enum: `Add, Sub, Mul, Div, Pow`
   - Derive `Debug, Clone, Copy, PartialEq, Eq` on BinOp
   - `AstNode` enum:
     - `Integer(i64)` -- small integer literal
     - `BigInteger(String)` -- large integer literal (evaluator converts to QInt)
     - `Q` -- the q indeterminate
     - `Infinity` -- infinity keyword
     - `LastResult` -- `%` reference
     - `Variable(String)` -- variable reference by name
     - `BinOp { op: BinOp, lhs: Box<AstNode>, rhs: Box<AstNode> }` -- binary operation
     - `Neg(Box<AstNode>)` -- unary negation
     - `FuncCall { name: String, args: Vec<AstNode> }` -- function call
     - `Assign { name: String, value: Box<AstNode> }` -- variable assignment (:=)
   - Derive `Debug, Clone, PartialEq` on AstNode
   - `Terminator` enum: `Semi, Colon, Implicit`
   - Derive `Debug, Clone, Copy, PartialEq, Eq` on Terminator
   - `Stmt` struct: `{ pub node: AstNode, pub terminator: Terminator }`
   - Derive `Debug, Clone, PartialEq` on Stmt
   - Note: AstNode does NOT carry spans (per research recommendation to keep it simple; errors come from parser position). If Phase 25 needs spans, they can be added later via a Spanned<T> wrapper.

3. Create `crates/qsym-cli/src/error.rs`:
   - `ParseError` struct: `{ pub message: String, pub span: Span }`
   - `use crate::token::Span;`
   - Implement `ParseError::render(&self, source: &str) -> String`:
     - Format: "parse error at column {col+1}: {message}\n  {source}\n  {caret}"
     - Column is `self.span.start` (byte offset = column for ASCII input)
     - Caret line: spaces to column, then `^`
   - Implement `Display` for ParseError: "parse error at byte {start}: {message}"
   - Implement `std::error::Error` for ParseError
   - Derive `Debug, Clone` on ParseError

4. Ensure `lib.rs` has `pub mod ast; pub mod token; pub mod error;` (created in Task 1).
  </action>
  <verify>
Run: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /c/cygwin64/home/Owner/Kangaroo && cargo test -p qsym-cli 2>&1`
Must compile with zero errors and zero warnings. Add a trivial `#[test]` in each module to verify:
- `token.rs`: test that `Token::Integer(42)` equals itself
- `ast.rs`: test that `AstNode::Integer(42)` equals itself
- `error.rs`: test that `ParseError::render` produces expected caret output for a known input
  </verify>
  <done>All AST, Token, Span, and Error types are defined, compile cleanly, and have basic tests confirming construction and equality. The type system covers the full Maple-style grammar: 17 token variants, 10 AST node variants, 3 terminator variants.</done>
</task>

</tasks>

<verification>
1. `cargo check -p qsym-cli` succeeds
2. `cargo test -p qsym-cli` passes all tests
3. `cargo check --workspace` succeeds (no workspace breakage)
4. Token enum has 17 variants covering the full grammar
5. AstNode enum has 10 variants covering all expression types
6. ParseError::render produces caret-style error messages
</verification>

<success_criteria>
- qsym-cli is a workspace member that compiles alongside qsym-core and qsym-python
- All type definitions are complete and match the grammar from the research document
- No dependencies beyond qsym-core (parser is hand-written)
- Types are ready for the lexer and parser implementation in Plan 24-02
</success_criteria>

<output>
After completion, create `.planning/phases/24-parser-ast/24-01-SUMMARY.md`
</output>
