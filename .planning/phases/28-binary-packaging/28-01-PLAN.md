---
phase: 28
plan: 1
title: "Release build configuration and CI workflow for binary artifacts"
estimates:
  tasks: 4
  complexity: low
  time: "10 min"
requirements:
  - BIN-01
  - BIN-02
depends_on: []
---

# Plan 28-01: Release Build Configuration and CI Workflow for Binary Artifacts

## Context

Phase 27 completed all REPL functionality. The CLI binary already compiles with `cargo build --release -p qsym-cli` producing a 4.5MB `q-kangaroo.exe` for `x86_64-pc-windows-gnu`. The binary dynamically links 4 MinGW DLLs: `libgmp-10.dll`, `libmpfr-6.dll`, `libmpc-3.dll`, `libgcc_s_seh-1.dll`. All system DLLs (KERNEL32, USER32, etc.) are present on any Windows 10+ installation.

Existing CI:
- `ci.yml`: Runs Rust tests + Python tests + coverage on ubuntu-latest
- `release.yml`: Builds Python wheels for PyPI on tag push (`v*`)

This plan adds:
1. Release profile optimization in workspace Cargo.toml
2. A new `cli-release.yml` workflow that builds binaries for Windows and Linux, creates a GitHub Release with attached artifacts

Requirements says "Static GMP linking" is out of scope — we bundle DLLs on Windows. On Linux, libgmp-dev is statically available via `--target-feature=+crt-static` or bundled as `.so`.

## Tasks

### Task 1: Add release profile to workspace Cargo.toml

Optimize the release binary for size and performance.

**Actions:**
1. In root `Cargo.toml`, add a `[profile.release]` section after `[workspace]`:
   ```toml
   [profile.release]
   lto = true
   codegen-units = 1
   strip = "symbols"
   ```
   - `lto = true`: Link-time optimization for smaller, faster binary
   - `codegen-units = 1`: Better optimization at cost of compile time
   - `strip = "symbols"`: Remove debug symbols from release binary

**Tests:**
- Run `cargo build --release -p qsym-cli` and verify it compiles without errors
- Verify resulting binary exists at `target/release/q-kangaroo.exe`

**Commit:** `feat(cli): add release profile optimization (LTO, strip, codegen-units=1)`

### Task 2: Create cli-release.yml CI workflow

Add a GitHub Actions workflow that builds standalone binaries on version tags.

**Actions:**
1. Create `.github/workflows/cli-release.yml`:

```yaml
name: CLI Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: linux-release-${{ hashFiles('**/Cargo.lock') }}
      - name: Install GMP
        run: sudo apt-get update && sudo apt-get install -y libgmp-dev libmpfr-dev libmpc-dev
      - name: Build release binary
        run: cargo build --release -p qsym-cli
      - name: Verify binary runs
        run: |
          chmod +x target/release/q-kangaroo
          target/release/q-kangaroo --version 2>/dev/null || echo "q-kangaroo built successfully"
          ls -la target/release/q-kangaroo
      - name: Package Linux binary
        run: |
          mkdir -p dist
          cp target/release/q-kangaroo dist/
          cd dist && tar czf q-kangaroo-linux-x86_64.tar.gz q-kangaroo
      - uses: actions/upload-artifact@v4
        with:
          name: binary-linux
          path: dist/q-kangaroo-linux-x86_64.tar.gz

  build-windows:
    name: Build Windows Binary
    runs-on: windows-latest
    steps:
      - name: Configure line endings
        shell: bash
        run: git config --global core.autocrlf input
      - uses: actions/checkout@v4
      - name: Setup MSYS2 with MinGW GMP
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          install: mingw-w64-x86_64-gcc mingw-w64-x86_64-gmp mingw-w64-x86_64-mpfr mingw-w64-x86_64-mpc
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu
      - name: Add MinGW to PATH
        shell: bash
        run: echo "D:/a/_temp/msys64/mingw64/bin" >> $GITHUB_PATH
      - name: Build release binary
        shell: bash
        env:
          LIBRARY_PATH: D:/a/_temp/msys64/mingw64/lib
          C_INCLUDE_PATH: D:/a/_temp/msys64/mingw64/include
        run: cargo build --release -p qsym-cli --target x86_64-pc-windows-gnu
      - name: Package Windows binary with DLLs
        shell: msys2 {0}
        run: |
          mkdir -p dist/q-kangaroo-windows
          cp target/x86_64-pc-windows-gnu/release/q-kangaroo.exe dist/q-kangaroo-windows/
          cp /mingw64/bin/libgmp-10.dll dist/q-kangaroo-windows/
          cp /mingw64/bin/libmpfr-6.dll dist/q-kangaroo-windows/
          cp /mingw64/bin/libmpc-3.dll dist/q-kangaroo-windows/
          cp /mingw64/bin/libgcc_s_seh-1.dll dist/q-kangaroo-windows/
          cp /mingw64/bin/libwinpthread-1.dll dist/q-kangaroo-windows/
          cd dist && 7z a q-kangaroo-windows-x86_64.zip q-kangaroo-windows/
      - uses: actions/upload-artifact@v4
        with:
          name: binary-windows
          path: dist/q-kangaroo-windows-x86_64.zip

  create-release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          merge-multiple: true
          path: dist/
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/q-kangaroo-linux-x86_64.tar.gz
            dist/q-kangaroo-windows-x86_64.zip
```

Key design decisions:
- Triggers on `v*` tags (same as existing release.yml) plus `workflow_dispatch` for manual testing
- Windows build uses MSYS2 for GMP/MPFR/MPC, same pattern as existing release.yml
- Bundles 5 DLLs: libgmp-10, libmpfr-6, libmpc-3, libgcc_s_seh-1, libwinpthread-1
- Uses `softprops/action-gh-release@v2` for GitHub Release creation with auto-generated release notes
- `permissions: contents: write` needed for creating releases
- Linux binary packaged as `.tar.gz`, Windows as `.zip` with DLLs in a folder

**Commit:** `feat(ci): add CLI release workflow for Windows and Linux binaries`

### Task 3: Add --version flag to CLI

The CI workflow calls `q-kangaroo --version` for verification. Add minimal version output.

**Actions:**
1. In `crates/qsym-cli/src/main.rs`, add before the `print_banner()` call:
   ```rust
   // Handle --version flag (for CI verification)
   let args: Vec<String> = std::env::args().collect();
   if args.len() > 1 && (args[1] == "--version" || args[1] == "-V") {
       println!("q-kangaroo {}", env!("CARGO_PKG_VERSION"));
       return;
   }
   ```
2. This ensures `q-kangaroo --version` prints version and exits without entering the REPL.

**Tests:**
- No unit test needed — this is a trivial CLI flag check
- Verified by CI workflow calling `q-kangaroo --version`

**Commit:** `feat(cli): add --version flag for CI verification`

### Task 4: Build verification and state updates

**Actions:**
1. Run `cargo build --release -p qsym-cli` — verify optimized binary compiles
2. Run `cargo test -p qsym-cli` — all existing tests still pass
3. Verify the binary size decreased with LTO+strip vs previous build

## Verification Criteria

| # | Truth | How to verify |
|---|-------|---------------|
| 1 | `cargo build --release -p qsym-cli` produces a standalone `.exe` for Windows | Task 1 build test |
| 2 | Release binary has LTO, strip, codegen-units=1 optimization | Cargo.toml profile.release section |
| 3 | cli-release.yml builds Linux binary on ubuntu-latest | CI workflow file exists with build-linux job |
| 4 | cli-release.yml builds Windows binary with bundled DLLs | CI workflow file exists with build-windows job, DLL copy steps |
| 5 | cli-release.yml creates GitHub Release with both artifacts | create-release job with softprops/action-gh-release |
| 6 | Binary shows welcome banner and enters REPL | Existing main.rs print_banner + readline loop |
| 7 | `--version` flag prints version and exits | main.rs args check |
| 8 | All existing tests still pass | cargo test -p qsym-cli |

## File Change Summary

| File | Action | Lines |
|------|--------|-------|
| `Cargo.toml` (root) | Add [profile.release] section | +4 |
| `.github/workflows/cli-release.yml` | Create new workflow | +95 |
| `crates/qsym-cli/src/main.rs` | Add --version flag | +6 |
