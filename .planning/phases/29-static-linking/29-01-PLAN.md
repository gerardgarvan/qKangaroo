---
phase: 29-static-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-core/Cargo.toml
  - .cargo/config.toml
autonomous: true
requirements:
  - BUILD-01

must_haves:
  truths:
    - "The q-kangaroo.exe binary has zero non-system DLL dependencies (no libgmp, libmpfr, libmpc, libgcc, libwinpthread)"
    - "GMP/MPFR/MPC are compiled from bundled C source by gmp-mpfr-sys build.rs, not linked from system libraries"
    - "The .cargo/config.toml no longer points to pre-installed GMP paths"
  artifacts:
    - path: "crates/qsym-core/Cargo.toml"
      provides: "gmp-mpfr-sys dependency without use-system-libs feature"
      contains: 'gmp-mpfr-sys = "1.6"'
    - path: ".cargo/config.toml"
      provides: "Empty or removed cargo config (no system GMP paths)"
  key_links:
    - from: "crates/qsym-core/Cargo.toml"
      to: "gmp-mpfr-sys build.rs"
      via: "Cargo feature flag removal triggers bundled source build"
      pattern: 'gmp-mpfr-sys = "1.6"'
---

<objective>
Enable static linking of GMP/MPFR/MPC by removing the `use-system-libs` feature from gmp-mpfr-sys and clearing the system library paths from `.cargo/config.toml`.

Purpose: This is the core change that eliminates all non-system DLL dependencies from the q-kangaroo binary. Without `use-system-libs`, gmp-mpfr-sys compiles GMP 6.3.0, MPFR 4.2.2, and MPC 1.3.1 from bundled C source and produces static `.a` archives that get linked into the binary.
Output: Modified Cargo.toml and cleaned .cargo/config.toml; locally verified static binary.
</objective>

<execution_context>
@C:/Users/Owner/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Owner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-static-linking/29-RESEARCH.md
@crates/qsym-core/Cargo.toml
@.cargo/config.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove use-system-libs and clear system GMP paths</name>
  <files>crates/qsym-core/Cargo.toml, .cargo/config.toml</files>
  <action>
In `crates/qsym-core/Cargo.toml`, change line 10 from:
```
gmp-mpfr-sys = { version = "1.6", features = ["use-system-libs"] }
```
to:
```
gmp-mpfr-sys = "1.6"
```

This single change switches gmp-mpfr-sys from linking against pre-installed system GMP to building GMP/MPFR/MPC from bundled C source as static libraries.

For `.cargo/config.toml`, remove the entire `[env]` section (all 5 lines: PKG_CONFIG_PATH, C_INCLUDE_PATH, LIBRARY_PATH, CFLAGS, LDFLAGS). These paths point to the pre-built GMP at `C:/mingw64-gcc/mingw64/` and would cause the linker to find dynamic `.dll.a` import libraries even after removing `use-system-libs` (see Research Pitfall 2). The file can be left empty or deleted entirely.

IMPORTANT: The `.cargo/config.toml` env vars MUST be removed, not just the Cargo feature. If they remain, the build may still find system GMP and link dynamically.
  </action>
  <verify>
Confirm the Cargo.toml change:
```bash
grep "gmp-mpfr-sys" crates/qsym-core/Cargo.toml
```
Should show `gmp-mpfr-sys = "1.6"` with NO `use-system-libs`.

Confirm the config.toml is clean:
```bash
cat .cargo/config.toml
```
Should be empty or not contain LIBRARY_PATH / C_INCLUDE_PATH.
  </verify>
  <done>
`crates/qsym-core/Cargo.toml` has `gmp-mpfr-sys = "1.6"` (no features). `.cargo/config.toml` has no `[env]` section with system GMP paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build locally and verify static linking</name>
  <files></files>
  <action>
Build the release binary locally to verify static linking works. The build environment needs m4, make, gcc, diff, and sh in PATH for gmp-mpfr-sys's build.rs to compile GMP from source.

Set up PATH for the build (Cygwin environment):
```bash
export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH"
```

Run the build:
```bash
cargo build --release -p qsym-cli
```

NOTE: First build will take 2-5 minutes because GMP/MPFR/MPC are being compiled from C source. Subsequent builds will be cached by gmp-mpfr-sys.

If m4 is not found, install it in Cygwin: the Cygwin m4 package provides `/usr/bin/m4` which should already be in PATH via `/c/cygwin64/bin`. If the build fails due to missing tools, check that `m4`, `make`, `gcc`, `diff`, and `sh` are all available.

After building, verify the binary has no non-system DLL dependencies:
```bash
objdump -p target/release/q-kangaroo.exe | grep "DLL Name"
```

The output MUST show only Windows system DLLs:
- KERNEL32.dll (or KERNEL32.DLL)
- USER32.dll (or similar system DLLs)
- ntdll.dll
- ADVAPI32.dll
- bcryptprimitives.dll
- api-ms-win-crt-* DLLs

The output MUST NOT show:
- libgmp-10.dll
- libmpfr-6.dll
- libmpc-3.dll
- libgcc_s_seh-1.dll
- libwinpthread-1.dll

Also verify the binary runs:
```bash
target/release/q-kangaroo.exe --version
```
  </action>
  <verify>
```bash
objdump -p target/release/q-kangaroo.exe | grep "DLL Name"
```
Output contains ONLY system DLLs (KERNEL32, ntdll, ADVAPI32, bcryptprimitives, api-ms-win-crt-*). No libgmp, libmpfr, libmpc, libgcc, libwinpthread.

```bash
target/release/q-kangaroo.exe --version
```
Prints version string successfully.
  </verify>
  <done>
Release binary builds successfully with static GMP/MPFR/MPC. `objdump -p` confirms zero non-system DLL dependencies. Binary runs and prints version.
  </done>
</task>

</tasks>

<verification>
1. `grep "use-system-libs" crates/qsym-core/Cargo.toml` returns no matches
2. `.cargo/config.toml` does not contain `LIBRARY_PATH` or `C_INCLUDE_PATH`
3. `objdump -p target/release/q-kangaroo.exe | grep "DLL Name"` shows only system DLLs
4. `target/release/q-kangaroo.exe --version` succeeds
</verification>

<success_criteria>
The q-kangaroo.exe binary is fully statically linked with respect to GMP/MPFR/MPC. It has zero non-system DLL dependencies. This satisfies BUILD-01.
</success_criteria>

<output>
After completion, create `.planning/phases/29-static-linking/29-01-SUMMARY.md`
</output>
