---
phase: 46-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/qsym-cli/src/help.rs
  - crates/qsym-cli/src/repl.rs
autonomous: true
requirements: [DOC-02]

must_haves:
  truths:
    - "User can type `help for` and get syntax documentation with example"
    - "User can type `help proc` and get syntax documentation with example"
    - "User can type `help if` and get syntax documentation with example"
    - "Tab-completing `fo` at the REPL prompt offers `for` as a candidate"
    - "Tab-completing `pr` offers `proc` as a candidate (without trailing paren)"
    - "General help text lists for/proc/if under a Scripting category"
  artifacts:
    - path: "crates/qsym-cli/src/help.rs"
      provides: "for/proc/if help entries and updated general_help()"
      contains: "\"for\" =>"
    - path: "crates/qsym-cli/src/repl.rs"
      provides: "Keyword tab completion"
      contains: "keyword_names"
  key_links:
    - from: "crates/qsym-cli/src/help.rs"
      to: "function_help()"
      via: "match arms before FUNC_HELP lookup"
      pattern: "\"for\" => return Some"
    - from: "crates/qsym-cli/src/repl.rs"
      to: "complete_inner()"
      via: "keyword completion without trailing paren"
      pattern: "keyword_names"
---

<objective>
Add help entries for the three new language constructs (`for`, `proc`, `if`) and keyword tab completion to the REPL.

Purpose: DOC-02 requires `help for`, `help proc`, `help if` to return documentation. Users also need tab completion for scripting keywords (for, proc, if, elif, else, fi, od, end, local, RETURN, and, or, not, from, to, by, do, then).
Output: Updated help.rs with 3 special-case help entries + updated general_help(), updated repl.rs with keyword completion.
</objective>

<execution_context>
@C:/Users/Owner/.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-documentation/46-CONTEXT.md
@.planning/phases/46-documentation/46-RESEARCH.md
@crates/qsym-cli/src/help.rs
@crates/qsym-cli/src/repl.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add help for/proc/if entries and update general_help()</name>
  <files>crates/qsym-cli/src/help.rs</files>
  <action>
Add three special-case match arms in `function_help()` BEFORE the existing alias redirect + FUNC_HELP lookup. These are language constructs, not functions, so they bypass the FUNC_HELP array entirely (avoiding any count assertion changes).

Insert at the top of `function_help()`, before the `let lookup = match name {` line:

```rust
// Language construct help entries (not function calls -- bypass FUNC_HELP)
match name {
    "for" => return Some(String::from(
        "for var from start to end [by step] do body od\n\n\
         \x20 Execute body repeatedly with var taking values start, start+step, ..., end.\n\
         \x20 Default step is 1. Body statements are separated by ; or :\n\n\
         \x20 Example:\n\
         \x20   q> s := 0: for k from 1 to 5 do s := s + k od: s\n\
         \x20   15\n\n\
         \x20 See also: if, proc"
    )),
    "proc" => return Some(String::from(
        "name := proc(params) [local vars;] [option remember;] body; end\n\n\
         \x20 Define a named procedure. Local variables are scoped to the procedure.\n\
         \x20 Use RETURN(value) for early exit. option remember caches results.\n\n\
         \x20 Example:\n\
         \x20   q> f := proc(n) local k; k := n*n; k; end: f(5)\n\
         \x20   25\n\n\
         \x20 See also: for, if, RETURN"
    )),
    "if" => return Some(String::from(
        "if cond then body [elif cond then body] [else body] fi\n\n\
         \x20 Conditional evaluation. Only the matching branch executes.\n\
         \x20 Boolean operators: and, or, not. Comparisons: =, <>, <, >, <=, >=\n\n\
         \x20 Example:\n\
         \x20   q> if 3 > 2 then 1 else 0 fi\n\
         \x20   1\n\n\
         \x20 See also: for, proc"
    )),
    _ => {}
}
```

Also update `general_help()` to add a "Scripting:" category between the existing "Number Theory:" section and "Commands:" section:

```
Scripting:
  for            - for-loop: for var from start to end [by step] do body od
  if             - conditional: if cond then body [elif ...] [else body] fi
  proc           - procedure: name := proc(params) body; end
  RETURN         - early return from procedure: RETURN(value)
```

Update the doc comment at the top of the file from "all 95 functions" to "all 97 functions + 3 language constructs" (or similar accurate description).

Add tests:
- `function_help_for_returns_some()`: assert `function_help("for").is_some()`, text contains "for var from"
- `function_help_proc_returns_some()`: assert `function_help("proc").is_some()`, text contains "proc"
- `function_help_if_returns_some()`: assert `function_help("if").is_some()`, text contains "if cond then"
- `general_help_contains_scripting_category()`: assert general_help text contains "Scripting:"

IMPORTANT: Do NOT add these to the FUNC_HELP array -- the special-case approach avoids changing the `assert_eq!(FUNC_HELP.len(), 95)` and `assert_eq!(canonical.len(), 95)` test assertions. Do NOT modify any existing help entries (per user decision: leave existing series/factor/subs help alone).
  </action>
  <verify>
Run `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /home/Owner/Kangaroo && cargo test -p qsym-cli --lib help -- 2>&1 | tail -20` -- all help tests pass including new ones.
  </verify>
  <done>
`help for` returns syntax documentation with example and "See also: if, proc". `help proc` returns syntax with example. `help if` returns syntax with example. General help text shows "Scripting:" category. All existing help tests still pass (FUNC_HELP count unchanged at 95).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add keyword tab completion to REPL</name>
  <files>crates/qsym-cli/src/repl.rs</files>
  <action>
Add a `keyword_names` field to `ReplHelper` struct:

```rust
pub struct ReplHelper {
    function_names: Vec<&'static str>,
    keyword_names: Vec<&'static str>,  // NEW
    command_names: Vec<&'static str>,
    var_names: Vec<String>,
}
```

Initialize in `new()`:
```rust
keyword_names: vec![
    "for", "from", "to", "by", "do", "od",
    "if", "then", "elif", "else", "fi",
    "proc", "local", "end",
    "RETURN",
    "and", "or", "not",
],
```

Update `complete_inner()` to also complete keywords. Keywords complete WITHOUT trailing `(` (unlike functions). Add keyword completion after function completion and before command completion:

```rust
// Complete keyword names (without auto-paren).
for &kw in &self.keyword_names {
    if kw.starts_with(prefix) {
        candidates.push((kw.to_string(), kw.to_string()));
    }
}
```

Note: `RETURN` uses function-call syntax `RETURN(value)` but is listed as a keyword here. It completes with auto-paren since it's already in `function_names` list. If RETURN is already in function_names (check -- it may not be), add it there instead. If it's NOT in function_names, add it to keyword_names and it will complete without paren, which is fine since the user will type `(` after it.

Check if RETURN is already in `canonical_function_names()` -- if yes, remove it from keyword_names to avoid duplicate completions. If no, leave it in keyword_names.

Update the doc comment on `ReplHelper` to mention keyword completion.

Add tests:
- `complete_for_keyword()`: complete_inner("fo", 2) returns candidates containing "for" with replacement "for" (no paren)
- `complete_proc_keyword()`: complete_inner("pr", 2) returns candidates containing "proc" with replacement "proc" (no paren). Note: "prove_eta_id", "prove_nonterminating", "prodmake" also match "pr" prefix, so check that "proc" is among candidates.
- `complete_if_keyword()`: complete_inner("if", 2) returns candidates containing "if" with replacement "if" (no paren)
- `complete_return_keyword()`: Verify "RETURN" or "RET" prefix completes (behavior depends on whether RETURN is in function_names or keyword_names)
- `keyword_completion_no_paren()`: Verify that completing "od" gives replacement "od" not "od("

The existing `canonical_function_count` test asserts 97. Do NOT change this count. The keyword_names are separate from function_names.

IMPORTANT: Only add keywords that are NOT already completable. Check that none of "for", "proc", "if", etc. appear in `function_names` already (they should not -- function_names has 97 entries like aqprod, numbpart, etc., not language keywords).
  </action>
  <verify>
Run `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /home/Owner/Kangaroo && cargo test -p qsym-cli --lib repl -- 2>&1 | tail -20` -- all repl tests pass including new keyword completion tests.
  </verify>
  <done>
Tab-completing "fo" offers "for" (without paren). Tab-completing "pr" offers "proc" among candidates. Tab-completing "if" offers "if". All 17 scripting keywords are completable. Existing function and command completion tests still pass. canonical_function_count still 97.
  </done>
</task>

</tasks>

<verification>
Run full CLI test suite:
```bash
export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH"
cd /home/Owner/Kangaroo
cargo test -p qsym-cli 2>&1 | tail -5
```
All tests pass. help.rs FUNC_HELP count unchanged at 95. repl.rs function count unchanged at 97.
</verification>

<success_criteria>
- `help for` returns syntax + example + "See also" cross-references
- `help proc` returns syntax + example + "See also" cross-references
- `help if` returns syntax + example + "See also" cross-references
- `general_help()` includes "Scripting:" category listing for/if/proc/RETURN
- Tab completion offers all scripting keywords without trailing paren
- All existing CLI tests pass unchanged (no count assertion breakage)
</success_criteria>

<output>
After completion, create `.planning/phases/46-documentation/46-01-SUMMARY.md`
</output>
