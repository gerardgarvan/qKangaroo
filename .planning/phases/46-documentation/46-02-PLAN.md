---
phase: 46-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - manual/chapters/04b-scripting.typ
  - manual/main.typ
  - manual/chapters/00-title.typ
  - manual/chapters/01-quick-start.typ
  - manual/chapters/02-installation.typ
  - manual/chapters/03-cli-usage.typ
  - manual/chapters/04-expression-language.typ
autonomous: true
requirements: [DOC-01, DOC-03]

must_haves:
  truths:
    - "PDF manual contains a Scripting Language chapter with for-loop, if/elif/else, proc/end documentation"
    - "Scripting chapter follows workflow progression: variables -> loops -> conditionals -> procedures -> expression ops -> products"
    - "Three worked examples from qmaple.pdf are woven into the chapter near the features they demonstrate"
    - "Chapter 4 no longer claims there are no control-flow statements"
    - "All occurrences of '89 functions' in the manual are updated to the correct count"
    - "Bivariate series usage is documented inline with product function examples, not as a separate section"
  artifacts:
    - path: "manual/chapters/04b-scripting.typ"
      provides: "Scripting Language chapter (200-300 lines)"
      min_lines: 200
      contains: "Scripting Language"
    - path: "manual/main.typ"
      provides: "Include for new chapter"
      contains: "04b-scripting.typ"
    - path: "manual/chapters/04-expression-language.typ"
      provides: "Updated Chapter 4 text (no 'no control-flow' claim)"
  key_links:
    - from: "manual/main.typ"
      to: "manual/chapters/04b-scripting.typ"
      via: "#include"
      pattern: "include.*04b-scripting"
    - from: "manual/chapters/04b-scripting.typ"
      to: "manual/template.typ"
      via: "#import"
      pattern: "import.*template"
---

<objective>
Create the Scripting Language chapter for the PDF manual documenting all v3.0 features, update outdated function counts and Chapter 4 text, and weave 3 worked examples from qmaple.pdf into the chapter.

Purpose: DOC-01 requires a manual chapter on scripting (for, proc, if, series, factor, subs). DOC-03 requires 3 worked examples reproducing qmaple.pdf patterns. The manual also has stale "89 functions" references and an outdated Chapter 4 claim that there are no control-flow statements.
Output: New `04b-scripting.typ` chapter file, updated `main.typ` include, updated function counts in 5 chapter files, corrected Chapter 4 text.
</objective>

<execution_context>
@C:/Users/Owner/.claude/agents/gsd-executor.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-documentation/46-CONTEXT.md
@.planning/phases/46-documentation/46-RESEARCH.md
@manual/main.typ
@manual/template.typ
@manual/chapters/00-title.typ
@manual/chapters/01-quick-start.typ
@manual/chapters/04-expression-language.typ
@manual/chapters/05-products.typ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripting language chapter with worked examples</name>
  <files>manual/chapters/04b-scripting.typ</files>
  <action>
Create `manual/chapters/04b-scripting.typ` (~250-300 lines) as a new chapter documenting all v3.0 scripting features. Use `#import "../template.typ": *` at the top. Follow the workflow progression (simple -> complex) per user decision.

**Chapter structure (one chapter per user discretion -- content fits well in one):**

```
= Scripting Language

[Brief intro: v3.0 adds control flow, procedures, expression operations, and symbolic product support]

== For Loops
#index[for loops]
- Syntax: `for var from start to end [by step] do body od`
- Default step is 1; negative step for countdown
- Body statements separated by `;` or `:`
- Loop variable scoped: value persists after loop ends (Maple behavior)
- REPL example using #repl-block showing basic for loop

=== Worked Example: Pentagonal Number Series
[WORKED EXAMPLE 1 -- woven here near for-loops]
- Cite: "cf. Garvan, 'A q-Product Tutorial for a q-Series Maple Package' (1998), Section 4"
- Show computing partial Euler pentagonal series using a for-loop:
  s := 0:
  for n from -5 to 5 do
    s := s + (-1)^n * q^(n*(3*n-1)/2):
  od:
  series(s, q, 20)
- Show comparing with aqprod(q, q, infinity, 20) to verify Euler's pentagonal theorem
- Use #repl-block for multi-line examples

== Boolean and Comparison Operators
#index[boolean operators]
#index[comparison operators]
- Table of comparison operators: =, <>, <, >, <=, >=
- Table of boolean operators: and, or, not
- Precedence: not > and > or (not binds tightest)
- Short-circuit evaluation: and/or stop early
- #repl examples

== If/Elif/Else Conditionals
#index[conditionals]
- Syntax: `if cond then body [elif cond then body] [else body] fi`
- Multiple elif branches allowed
- #repl-block examples showing if, if/else, if/elif/else

== Procedures
#index[procedures]
- Syntax: `name := proc(params) [local vars;] [option remember;] body; end`
- Local variables: scoped to procedure, do not leak to global
- RETURN(value): early exit from procedure
- option remember: memoization (cached results for repeated calls)
- #repl examples

=== Worked Example: Memoized Partition Recurrence
[WORKED EXAMPLE 2 -- woven here near procedures]
- Cite: "cf. Garvan, 'A q-Product Tutorial for a q-Series Maple Package' (1998), Section 7"
- Show procedure with option remember implementing Euler's partition recurrence:
  prec := proc(n)
    option remember;
    local k, s;
    if n < 0 then RETURN(0) fi;
    if n = 0 then RETURN(1) fi;
    s := 0:
    for k from 1 to n do
      if k*(3*k-1)/2 > n then RETURN(s) fi;
      s := s + (-1)^(k+1) * (prec(n - k*(3*k-1)/2) + prec(n - k*(3*k+1)/2)):
    od:
    s;
  end:
  prec(20)
- Show output: 627 (matching numbpart(20))
- This demonstrates: proc, local, option remember, RETURN, for, if, recursion

== Expression Operations
#index[expression operations]
- Use #func-entry for series() and expand()
- series(expr, q, T): truncate to O(q^T)
- expand(expr) or expand(jacprod, q, T): expand products into series form
- #repl examples

== Polynomial Operations
#index[polynomial operations]
- Use #func-entry for factor() and subs()
- factor(poly): factor polynomial in q into irreducible/cyclotomic factors
- subs(q=val, expr): substitute a value for q
- #repl examples

== Number Theory Functions
#index[number theory]
- Brief entries for floor() and legendre() (these are small utility functions)
- #repl examples

== Symbolic Products
#index[symbolic products]
#index[bivariate series]
- Document tripleprod(z, q, T), quinprod(z, q, T), winquist(a, b, q, T) with symbolic variables
- When first argument is a symbol (not a q-monomial), these produce bivariate Laurent polynomials in z with q-series coefficients
- Show bivariate display format

=== Worked Example: Jacobi Triple Product Identity
[WORKED EXAMPLE 3 -- woven here near symbolic products]
- Cite: "cf. Garvan, 'A q-Product Tutorial for a q-Series Maple Package' (1998), Section 2"
- Show: tripleprod(z, q, 10) producing bivariate output
- Show verifying Jacobi triple product: sum_{n} (-1)^n z^n q^{n(n-1)/2} = tripleprod(z, q, T)
- Use #repl-block for the examples
```

**IMPORTANT formatting rules (per user decisions):**
- Use `#repl()` and `#repl-block()` from template.typ for all code examples
- Use `#func-entry()` for series/expand/factor/subs reference entries
- Use `#index[]` and `#index-main[]` for index entries
- Minimal commentary -- let code speak for itself
- q-Kangaroo code only for worked examples (no Maple originals)
- Cite specific qmaple.pdf sections for worked examples
- Include "Notes" subsection only where genuinely needed for Maple differences

**CRITICAL: Run each worked example in the actual REPL before writing output.**
Before writing the chapter, run the following in the REPL to capture exact output:
1. The pentagonal series for-loop example
2. The memoized partition recurrence procedure
3. The tripleprod(z, q, 10) bivariate example
4. Any other example whose output you include

Use: `export PATH="/c/mingw64-gcc/mingw64/bin:/c/cygwin64/bin:/c/Users/Owner/.cargo/bin:$PATH" && cd /home/Owner/Kangaroo && cargo run -p qsym-cli --release -- -c "expression_here"`

This ensures the manual output matches actual REPL behavior (descending degree order, O(q^T) suffix, exact coefficient formatting).
  </action>
  <verify>
Verify the file exists and has the expected structure:
```bash
wc -l manual/chapters/04b-scripting.typ  # Should be 200-300 lines
grep -c "index\[" manual/chapters/04b-scripting.typ  # Should have multiple index entries
grep -c "repl" manual/chapters/04b-scripting.typ  # Should have multiple REPL examples
grep "qmaple" manual/chapters/04b-scripting.typ  # Should cite qmaple.pdf
grep "func-entry" manual/chapters/04b-scripting.typ  # Should have func-entry for series/expand/factor/subs
```
  </verify>
  <done>
New chapter file `04b-scripting.typ` exists with 200-300 lines. Contains sections for for-loops, boolean operators, conditionals, procedures, expression ops, polynomial ops, number theory, and symbolic products. Three worked examples woven in near relevant features with qmaple.pdf citations. All REPL output verified against actual binary.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main.typ, function counts, and Chapter 4 text</name>
  <files>manual/main.typ, manual/chapters/00-title.typ, manual/chapters/01-quick-start.typ, manual/chapters/02-installation.typ, manual/chapters/03-cli-usage.typ, manual/chapters/04-expression-language.typ</files>
  <action>
**2a. Update main.typ** -- Add the new chapter include AFTER Chapter 4:
Line 50 currently: `#include "chapters/04-expression-language.typ"`
Insert after it: `#include "chapters/04b-scripting.typ"`

**2b. Update function count from "89" to "97"** in these 5 files. The count 97 matches the total canonical function names in the REPL tab completion (confirmed by `canonical_function_count` test asserting 97). Alternatively, verify the exact count by examining what general_help() lists plus session functions -- the executor should confirm this. If the exact count differs, use the correct number.

Files and locations:
1. `manual/chapters/00-title.typ` line 21: change "all 89 built-in functions" to "all 97 built-in functions"
2. `manual/chapters/01-quick-start.typ` line 84: change "all 89 built-in functions" to "all 97 built-in functions"
3. `manual/chapters/02-installation.typ` line 69: change "same 89 functions" to "same 97 functions"
4. `manual/chapters/03-cli-usage.typ` line 129: change "all 89 functions" to "all 97 functions"
5. `manual/chapters/04-expression-language.typ` line 130: change "89 built-in functions organized into 9 groups" to "97 built-in functions organized into 14 groups" (the groups are now: Products, Partitions, Theta, Jacobi Products, Expression Operations, Polynomial Operations, Series Analysis, Relations, Hypergeometric, Mock Theta & Bailey, Identity Proving, Number Theory, Variable Management, plus Scripting constructs = ~14 categories)

**2c. Update Chapter 4 (04-expression-language.typ) outdated text:**

1. Lines 14-17: The Overview section says "There are no control-flow statements (loops, conditionals) -- the language is designed for evaluating mathematical expressions, not general-purpose programming." Change this to something like: "The language also supports control-flow statements (for-loops, if/elif/else conditionals) and procedure definitions, described in the next chapter."

2. Update the function group listing (lines 130-142) to include the new categories (Expression Operations, Polynomial Operations, Number Theory) that were added in v3.0. The current listing shows 9 groups but there are now more. Update to show all current groups with correct counts, or add the missing groups to the bulleted list. Reference the new scripting chapter for for/proc/if.

3. Update the Value Types table (lines 182-230) to add these new types:
   - **Symbol**: A bare name (undefined variable). Produced by referencing names not bound to a value. Used as symbolic parameters in product functions.
   - **Procedure**: A user-defined function created with `proc ... end`. Can be called like a built-in function.
   - **JacobiProduct**: A symbolic Jacobi product `JAC(a,b)`. Supports arithmetic and can be expanded to series with `jac2series` or `expand`.
   - **BivariateSeries**: A Laurent polynomial in a symbolic variable (z) with q-series coefficients. Produced by `tripleprod(z,q,T)` etc. when the first argument is symbolic.

**2d. Add a forward reference** from Chapter 4 to the new scripting chapter: After the Overview section, add a sentence like "See the next chapter for scripting features including loops, conditionals, and procedures."

Do NOT modify chapters 05-15 (products through appendix). Per CONTEXT.md, bivariate documentation goes in the new scripting chapter's symbolic products section, not in Chapter 5.
  </action>
  <verify>
```bash
# Verify main.typ has the include
grep "04b-scripting" manual/main.typ

# Verify no remaining "89" in manual chapters (except the worked-examples Rogers 1894 reference which is unrelated)
grep -rn "89" manual/chapters/*.typ | grep -v "1894" | grep -v Rogers

# Verify Chapter 4 no longer says "no control-flow"
grep -c "no control-flow\|There are no control-flow" manual/chapters/04-expression-language.typ  # Should be 0

# Verify new value types added
grep "Symbol\|Procedure\|JacobiProduct\|BivariateSeries" manual/chapters/04-expression-language.typ
```
  </verify>
  <done>
main.typ includes 04b-scripting.typ. All 5 files updated from "89" to correct function count. Chapter 4 overview no longer claims "no control-flow" -- replaced with forward reference to scripting chapter. Value Types table includes Symbol, Procedure, JacobiProduct, BivariateSeries. Function group listing updated with all current categories.
  </done>
</task>

</tasks>

<verification>
If Typst 0.14.2 is available on the system, compile the PDF to check for errors:
```bash
typst compile manual/main.typ manual/q-kangaroo-manual.pdf 2>&1
```
If Typst is not available, verify structural correctness:
```bash
# All includes resolve
for f in $(grep '#include' manual/main.typ | sed 's/.*"chapters\//manual\/chapters\//' | sed 's/".*//' ); do
  test -f "$f" && echo "OK: $f" || echo "MISSING: $f"
done

# New chapter uses template correctly
grep "import.*template" manual/chapters/04b-scripting.typ
```
</verification>

<success_criteria>
- New chapter `04b-scripting.typ` exists with ~250 lines covering for/if/proc/series/expand/factor/subs/symbolic products
- Three worked examples woven in: (1) pentagonal series for-loop near for-loops section, (2) memoized partition procedure near procedures section, (3) tripleprod bivariate near symbolic products section
- All qmaple.pdf citations present with section numbers
- Chapter 4 updated: no "no control-flow" claim, new value types, updated group listing
- Function count updated from "89" to correct number in all 5 files
- main.typ includes the new chapter after chapter 04
</success_criteria>

<output>
After completion, create `.planning/phases/46-documentation/46-02-SUMMARY.md`
</output>
