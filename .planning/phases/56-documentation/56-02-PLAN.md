---
phase: 56-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - manual/chapters/17-v5-changes.typ
  - manual/main.typ
  - manual/chapters/16-v4-changes.typ
autonomous: true
requirements:
  - DOC-02

must_haves:
  truths:
    - "PDF manual has a chapter titled 'What's New in v5.0'"
    - "The v5.0 chapter documents while loops with syntax and safety limit"
    - "The v5.0 chapter documents print() with return-value behavior"
    - "The v5.0 chapter documents list literals, indexing, nops, op, map, sort"
    - "The v5.0 chapter documents coeff, degree, numer, denom, modp, mods, type, evalb, cat"
    - "The v5.0 chapter documents add/mul/seq with i=a..b range syntax"
    - "The v5.0 chapter documents the polynomial division hang fix"
    - "The v4.0 chapter no longer says while loops are unsupported"
  artifacts:
    - path: "manual/chapters/17-v5-changes.typ"
      provides: "v5.0 changelog chapter with usage examples for all new features"
      min_lines: 150
    - path: "manual/main.typ"
      provides: "Include directive for 17-v5-changes.typ"
      contains: "17-v5-changes.typ"
    - path: "manual/chapters/16-v4-changes.typ"
      provides: "Removed stale while-loop 'Not Yet Supported' bullet"
  key_links:
    - from: "manual/main.typ"
      to: "manual/chapters/17-v5-changes.typ"
      via: "#include directive"
      pattern: "include.*17-v5-changes"
    - from: "manual/chapters/17-v5-changes.typ"
      to: "manual/template.typ"
      via: "#import for repl, repl-block, index, func-entry macros"
      pattern: "import.*template"
---

<objective>
Create a PDF manual chapter documenting all v5.0 additions and fix stale v4.0 content.

Purpose: The PDF manual needs a "What's New in v5.0" chapter covering all features from Phases 52-55 (while loops, print(), lists, series/utility functions, iteration with ranges, polynomial division fix, Unicode resilience). The existing v4.0 chapter incorrectly says while loops are unsupported.

Output: New chapter 17-v5-changes.typ with usage examples, updated main.typ includes, and corrected 16-v4-changes.typ.
</objective>

<execution_context>
@.planning/phases/56-documentation/56-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@manual/template.typ
@manual/main.typ
@manual/chapters/16-v4-changes.typ
@manual/chapters/04b-scripting.typ
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v5.0 chapter and update main.typ and v4.0 chapter</name>
  <files>manual/chapters/17-v5-changes.typ, manual/main.typ, manual/chapters/16-v4-changes.typ</files>
  <action>
  **Create `manual/chapters/17-v5-changes.typ`** following the structure of 16-v4-changes.typ. Use the template macros: `#repl()`, `#repl-block()`, `#func-entry()`, `#index[]`, `#index-main[]`.

  Chapter structure:

  ```
  = What's New in v5.0

  Introductory paragraph: v5.0 closes remaining Maple language and function gaps. This chapter documents all features introduced in Phases 52-55.

  == Bug Fixes

  === Polynomial Division Fix
  - Explain: division by dense polynomials (e.g. 1/aqprod(q,q,5)) previously could hang
  - Internal fix: POLYNOMIAL_ORDER sentinel prevents infinite expansion
  - Example: `1/aqprod(q,q,5)` now returns a series instantly

  == Language Features

  === While Loops
  - Syntax: while condition do body od
  - Example: i:=0: while i<10 do i:=i+1 od: i => 10
  - Note safety limit: 1,000,000 iterations maximum
  - Note: while does not introduce a new scope (unlike for)
  - Multi-line in REPL supported (auto-detects incomplete input)

  === The print() Function
  - Syntax: print(expr, ...)
  - Displays intermediate values in loops/procedures
  - Returns the last argument (not NULL, unlike Maple)
  - Example: for k from 1 to 3 do print(k^2) od => 1, 4, 9

  === List Literals and Indexing
  - Syntax: [a, b, c] creates a list
  - 1-indexed (Maple convention); L[0] is out-of-range error
  - Nested lists supported: [[1,2],[3,4]]
  - Indexed assignment: L[2] := 99
  - Example: L := [10,20,30]: L[2] => 20

  === Range Syntax (DotDot)
  - Syntax: i=a..b used in add, mul, seq
  - Not valid outside iteration functions (produces clear error)
  - Example: add(i^2, i=1..5) => 55

  === Unicode Paste Resilience
  - Unicode math characters (minus sign U+2212, caret variants, etc.) auto-normalize to ASCII
  - Researchers can paste from PDFs/webpages without errors

  == New Functions

  === List Operations
  - func-entry for nops: nops(expr) -- number of operands; nops on FPS counts nonzero terms
  - func-entry for op: op(i, expr) -- extract i-th operand; on series returns [exp, coeff]
  - func-entry for map: map(f, list) -- apply function to each element
  - func-entry for sort: sort(list) -- sort numerically or lexicographically

  === Series Coefficients
  - func-entry for coeff: coeff(f, q, n) -- extract coefficient of q^n; returns Integer when denom=1
  - func-entry for degree: degree(f, q) -- highest power with nonzero coefficient

  === Rational Decomposition
  - func-entry for numer: numer(r) -- numerator of rational
  - func-entry for denom: denom(r) -- denominator of rational

  === Modular Arithmetic
  - func-entry for modp: modp(a, p) -- a mod p, non-negative result
  - func-entry for mods: mods(a, p) -- a mod p, symmetric/centered at 0
  - Example showing correct negative handling: modp(-7, 3) => 2, mods(5, 3) => -1

  === Type and Evaluation
  - func-entry for type: type(expr, typename) -- check expression type; accepts Symbol or String
  - func-entry for evalb: evalb(expr) -- evaluate boolean expression

  === String/Name Operations
  - func-entry for cat: cat(a, b, ...) -- concatenate into Symbol (not String)

  === Iteration
  - func-entry for add: add(expr, i=a..b) -- sum over range; empty range returns 0
  - func-entry for mul: mul(expr, i=a..b) -- product over range; empty range returns 1
  - func-entry for seq: seq(expr, i=a..b) -- generate list; empty range returns []

  === Variable Management
  - Brief entry for anames: anames() -- list assigned variable names
  - Brief entry for restart: restart() -- clear all and reset
  ```

  Use `#func-entry()` for the function reference entries (nops, op, map, sort, coeff, degree, numer, denom, modp, mods, type, evalb, cat, add, mul, seq). For simpler functions (anames, restart), a brief heading + `#repl()` example suffices.

  Use `#repl()` for single-line examples and `#repl-block()` for multi-line transcripts.

  Add `#index[]` and `#index-main[]` entries for all major topics (while loops, lists, print, each function name, etc.).

  **Update `manual/main.typ`:** Add `#include "chapters/17-v5-changes.typ"` on the line after `#include "chapters/16-v4-changes.typ"` and before `#include "chapters/15-appendix.typ"`.

  **Update `manual/chapters/16-v4-changes.typ`:** Replace lines 529-531 (the while-loop "Not Yet Supported" bullet):
  ```
  // OLD (lines 529-531):
  - *`while` loops:* No examples in _qmaple.pdf_ use `while` loops, but
    this is a general language limitation. Use `for` loops with explicit
    bounds instead.

  // NEW:
  - *`while` loops:* Now supported in v5.0. See the _What's New in v5.0_
    chapter.
  ```

  IMPORTANT: All REPL examples must be accurate. Use actual output from the q-Kangaroo REPL. For series output, keep it brief with O(q^T) truncation. If unsure about exact output formatting, test with `echo 'expr' | cargo run -p qsym-cli --` or use known-good output from help entries.
  </action>
  <verify>
  1. Verify the Typst file is syntactically valid by checking it has matching braces and valid import:
     `head -3 manual/chapters/17-v5-changes.typ` should show `#import "../template.typ": *`

  2. Verify main.typ includes the new chapter:
     `grep "17-v5-changes" manual/main.typ`

  3. Verify 16-v4-changes.typ no longer says while loops are a "general language limitation":
     `grep -c "general language limitation" manual/chapters/16-v4-changes.typ` should return 0

  4. Verify the chapter covers all required topics:
     `grep -c "while\|print\|nops\|coeff\|add.*range\|List\|modp\|type\|evalb\|cat\|sort\|map\|op\|degree\|numer\|denom\|mods\|mul\|seq" manual/chapters/17-v5-changes.typ` should be large (>20)

  Note: Typst compilation (typst compile) happens in CI only. Local verification checks file structure and content coverage.
  </verify>
  <done>
  manual/chapters/17-v5-changes.typ exists with 150+ lines covering all v5.0 features. main.typ includes it before the appendix. 16-v4-changes.typ no longer lists while loops as unsupported. Every new function from Phases 52-55 has a usage example in the chapter.
  </done>
</task>

</tasks>

<verification>
Content coverage check -- every v5.0 feature must appear in the chapter:

Language features: while loops, print(), list literals, list indexing, DotDot range syntax, Unicode paste resilience
Bug fixes: polynomial division hang
New functions (16): nops, op, map, sort, coeff, degree, numer, denom, modp, mods, type, evalb, cat, add, mul, seq
Variable management (2): anames, restart

The v4.0 chapter must not contain "general language limitation" regarding while loops.
</verification>

<success_criteria>
- manual/chapters/17-v5-changes.typ exists with 150+ lines
- main.typ includes 17-v5-changes.typ before 15-appendix.typ
- 16-v4-changes.typ while-loop "Not Yet Supported" bullet is updated to reference v5.0
- Every new function has at least one REPL example in the chapter
- All #index entries present for back-of-book index generation
</success_criteria>

<output>
After completion, create `.planning/phases/56-documentation/56-02-SUMMARY.md`
</output>
